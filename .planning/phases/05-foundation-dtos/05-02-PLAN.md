---
phase: 05-foundation-dtos
plan: 02
type: execute
wave: 2
depends_on: ["05-01"]
files_modified:
  - reportcard-server/src/main/java/io/github/ericdriggs/reportcard/controller/browse/BrowseJsonController.java
  - reportcard-server/src/test/java/io/github/ericdriggs/reportcard/controller/browse/BrowseJsonControllerTest.java
autonomous: true

must_haves:
  truths:
    - "GET /v1/api returns JSON with companies array containing company objects (not toString keys)"
    - "GET /v1/api/company/{company} returns JSON with company object and orgs array"
    - "GET /v1/api/company/{company}/org/{org} returns JSON with org object and repos array"
    - "All three endpoints return HTTP 200 with valid JSON structure"
    - "Existing tests pass after update to new response types"
  artifacts:
    - path: "reportcard-server/src/main/java/io/github/ericdriggs/reportcard/controller/browse/BrowseJsonController.java"
      provides: "Updated controller using Response DTOs"
      contains: "CompanyOrgsResponse"
    - path: "reportcard-server/src/test/java/io/github/ericdriggs/reportcard/controller/browse/BrowseJsonControllerTest.java"
      provides: "Updated tests for new response types"
      contains: "CompanyOrgsResponse"
  key_links:
    - from: "BrowseJsonController.getCompanyOrgs()"
      to: "CompanyOrgsResponse.fromMap()"
      via: "method call in controller"
      pattern: "CompanyOrgsResponse\\.fromMap"
    - from: "BrowseJsonController.getCompanyOrgsRepos()"
      to: "CompanyOrgsReposResponse.fromMap()"
      via: "method call in controller"
      pattern: "CompanyOrgsReposResponse\\.fromMap"
    - from: "BrowseJsonController.getOrgReposBranches()"
      to: "OrgReposBranchesResponse.fromMap()"
      via: "method call in controller"
      pattern: "OrgReposBranchesResponse\\.fromMap"
---

<objective>
Wire the three Response DTOs to their corresponding BrowseJsonController endpoints and update tests.

Purpose: Transform the first three browse endpoints from returning Map<Pojo,...> to returning clean Response DTOs. This completes the Phase 5 goal of establishing the DTO pattern.

Output: Controller methods return DTOs, tests validate new response structure.
</objective>

<execution_context>
@/Users/eric.r.driggs/.claude/get-shit-done/workflows/execute-plan.md
@/Users/eric.r.driggs/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/05-foundation-dtos/05-CONTEXT.md
@.planning/phases/05-foundation-dtos/05-01-SUMMARY.md

Key files:
@reportcard-server/src/main/java/io/github/ericdriggs/reportcard/controller/browse/BrowseJsonController.java
@reportcard-server/src/test/java/io/github/ericdriggs/reportcard/controller/browse/BrowseJsonControllerTest.java
</context>

<tasks>

<task type="auto">
  <name>Task 1: Wire DTOs to Controller Endpoints</name>
  <files>reportcard-server/src/main/java/io/github/ericdriggs/reportcard/controller/browse/BrowseJsonController.java</files>
  <action>
Update three controller methods to return Response DTOs instead of raw Maps.

1. Update getCompanyOrgs():
   - Change return type from `ResponseEntity<Map<CompanyPojo, Set<OrgPojo>>>` to `ResponseEntity<CompanyOrgsResponse>`
   - Transform: `CompanyOrgsResponse.fromMap(CompanyOrgsCache.INSTANCE.getCache())`
   - Return: `new ResponseEntity<>(CompanyOrgsResponse.fromMap(...), HttpStatus.OK)`

2. Update getCompanyOrgsRepos():
   - Change return type from `ResponseEntity<Map<CompanyPojo, Map<OrgPojo, Set<RepoPojo>>>>` to `ResponseEntity<CompanyOrgsReposResponse>`
   - Transform: `CompanyOrgsReposResponse.fromMap(CompanyOrgsReposCacheMap.INSTANCE.getValue(...))`
   - Return: `new ResponseEntity<>(CompanyOrgsReposResponse.fromMap(...), HttpStatus.OK)`

3. Update getOrgReposBranches():
   - Change return type from `ResponseEntity<Map<OrgPojo, Map<RepoPojo, Set<BranchPojo>>>>` to `ResponseEntity<OrgReposBranchesResponse>`
   - Transform: `OrgReposBranchesResponse.fromMap(OrgReposBranchesCacheMap.INSTANCE.getValue(...))`
   - Return: `new ResponseEntity<>(OrgReposBranchesResponse.fromMap(...), HttpStatus.OK)`

Add imports for the new Response classes from io.github.ericdriggs.reportcard.controller.browse.response package.

DO NOT modify other controller methods - they stay as Map returns for now (Phase 6 scope).
  </action>
  <verify>
Compiles: `./gradlew compileJava -x generateJooqSchemaSource 2>&1 | tail -20`
  </verify>
  <done>
Three controller methods updated to return Response DTOs. Imports added. Code compiles.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update Tests for New Response Types</name>
  <files>reportcard-server/src/test/java/io/github/ericdriggs/reportcard/controller/browse/BrowseJsonControllerTest.java</files>
  <action>
Update the three test methods to use new Response DTO types.

1. Update getCompanyOrgsJsonSuccessTest():
   - Change response type from `ResponseEntity<Map<CompanyPojo, Set<OrgPojo>>>` to `ResponseEntity<CompanyOrgsResponse>`
   - Access data via `response.getBody().getCompanies()` (List<CompanyEntry>)
   - Update assertions to navigate new structure:
     - `entry.getCompany().getCompanyName()` instead of `entry.getKey().getCompanyName()`
     - `entry.getOrgs()` instead of `entry.getValue()`

2. Update getCompanyOrgsReposJsonSuccessTest():
   - Change response type from `ResponseEntity<Map<CompanyPojo, Map<OrgPojo, Set<RepoPojo>>>>` to `ResponseEntity<CompanyOrgsReposResponse>`
   - Access data via `response.getBody().getCompany()` and `response.getBody().getOrgs()`
   - Update assertions to navigate new structure

3. Update getOrgReposBranchesJsonSuccessTest():
   - Change response type from `ResponseEntity<Map<OrgPojo, Map<RepoPojo, Set<BranchPojo>>>>` to `ResponseEntity<OrgReposBranchesResponse>`
   - Access data via `response.getBody().getOrg()` and `response.getBody().getRepos()`
   - Update assertions to navigate new structure

Add imports for Response DTO classes.

Test assertions should verify:
- Response is not null
- HTTP 200 status
- Expected test data (company/org/repo names) present in response
- Structure is correct (objects not null, lists not empty)
  </action>
  <verify>
Run tests: `./gradlew test --tests "io.github.ericdriggs.reportcard.controller.browse.BrowseJsonControllerTest.getCompanyOrgsJsonSuccessTest" --tests "io.github.ericdriggs.reportcard.controller.browse.BrowseJsonControllerTest.getCompanyOrgsReposJsonSuccessTest" --tests "io.github.ericdriggs.reportcard.controller.browse.BrowseJsonControllerTest.getOrgReposBranchesJsonSuccessTest" 2>&1 | tail -30`
  </verify>
  <done>
Three test methods updated to use Response DTO types. Tests pass with new structure assertions.
  </done>
</task>

<task type="auto">
  <name>Task 3: Verify Full Test Suite</name>
  <files>reportcard-server/src/test/java/io/github/ericdriggs/reportcard/controller/browse/BrowseJsonControllerTest.java</files>
  <action>
Run the full BrowseJsonControllerTest suite to ensure:
1. Updated tests pass
2. Unchanged tests (for endpoints not yet converted) still pass
3. No regressions

If any test fails, analyze and fix. Common issues:
- Import statements missing
- Inner class access patterns wrong (need to check actual class structure from 05-01)
- Null checks needed for new optional fields
  </action>
  <verify>
Run full test class: `./gradlew test --tests "io.github.ericdriggs.reportcard.controller.browse.BrowseJsonControllerTest" 2>&1 | tail -50`
All tests should pass (expect ~20 tests based on test file review)
  </verify>
  <done>
Full BrowseJsonControllerTest suite passes. All existing functionality preserved, three endpoints now return clean JSON via DTOs.
  </done>
</task>

</tasks>

<verification>
1. `./gradlew test --tests "io.github.ericdriggs.reportcard.controller.browse.BrowseJsonControllerTest"` - all tests pass
2. Controller methods return DTO types (not Map types) for first three endpoints
3. JSON output structure matches CONTEXT.md specification:
   - /v1/api: `{"companies": [{"company": {...}, "orgs": [...]}]}`
   - /company/{company}: `{"company": {...}, "orgs": [{"org": {...}, "repos": [...]}]}`
   - /company/{company}/org/{org}: `{"org": {...}, "repos": [{"repo": {...}, "branches": [...]}]}`
</verification>

<success_criteria>
- GET /v1/api returns CompanyOrgsResponse with clean JSON structure
- GET /v1/api/company/{company} returns CompanyOrgsReposResponse with nested structure
- GET /v1/api/company/{company}/org/{org} returns OrgReposBranchesResponse with nested structure
- All BrowseJsonControllerTest tests pass
- No JSON keys contain "Pojo(" substring (verified by test assertions checking actual field values)
- Jackson serializes DTOs without custom serializers (standard annotations suffice)
</success_criteria>

<output>
After completion, create `.planning/phases/05-foundation-dtos/05-02-SUMMARY.md`
</output>
