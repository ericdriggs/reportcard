---
phase: 04.1-migrate-timing-to-test-result
plan: 01
subsystem: database
tags: [mysql, jooq, schema, datetime, migration]

# Dependency graph
requires:
  - phase: 01-schema-foundation
    provides: run.start_time/end_time columns, KARATE storage type, JOOQ regeneration workflow
  - phase: 03-api-integration
    provides: processKarateTiming method, Karate timing data flow
provides:
  - test_result table with start_time and end_time columns for per-stage timing
  - JOOQ TEST_RESULT.START_TIME and TEST_RESULT.END_TIME fields with Instant type
  - StagePathPersistService.updateTestResultTiming method
  - Controller writes timing to test_result table (testResultId-based)
affects: [05-client-library, future-dashboard, future-timing-reports]

# Tech tracking
tech-stack:
  added: []
  patterns: [test-result-timing, testResultId-based-timing-flow]

key-files:
  created: []
  modified:
    - reportcard-server/src/main/resources/db/migration/V1.0__reportcard_mysql_ddl.sql
    - reportcard-server/src/generated/java/io/github/ericdriggs/reportcard/gen/db/tables/TestResultTable.java
    - reportcard-server/src/generated/java/io/github/ericdriggs/reportcard/gen/db/tables/records/TestResultRecord.java
    - reportcard-server/src/main/java/io/github/ericdriggs/reportcard/persist/StagePathPersistService.java
    - reportcard-server/src/main/java/io/github/ericdriggs/reportcard/controller/JunitController.java

key-decisions:
  - "Added start_time and end_time as NULLable DATETIME columns after time column for logical grouping"
  - "Kept run.start_time/end_time columns for backward compatibility - additive-only migration"
  - "updateRunTiming method kept (not removed) for backward compatibility"
  - "No dual-write - new code writes only to test_result, run timing columns become stale"

patterns-established:
  - "Per-stage timing via test_result.start_time/end_time (not run-level)"
  - "Extract testResultId from stagePathTestResult.getTestResult().getTestResultId()"
  - "Timing flow: processKarateTiming -> updateTestResultTiming -> TEST_RESULT table"

# Metrics
duration: 10min
completed: 2026-01-27
---

# Phase 4.1 Plan 1: Migrate Timing to Test Result Summary

**Migrated timing columns from run to test_result table with JOOQ regeneration and controller data flow update**

## Performance

- **Duration:** 10 min
- **Started:** 2026-01-27T18:31:58Z
- **Completed:** 2026-01-27T18:42:04Z
- **Tasks:** 3
- **Files modified:** 5 (schema DDL, 4 JOOQ generated files, persistence service, controller)

## Accomplishments
- Added start_time and end_time DATETIME NULL columns to test_result table (both local and RDS MySQL)
- Regenerated JOOQ classes with TEST_RESULT.START_TIME and TEST_RESULT.END_TIME fields (Instant type)
- Created updateTestResultTiming persistence method following existing updateRunTiming pattern
- Updated controller to extract testResultId and call new persistence method
- All Karate integration tests pass (junit-only, karate-only, combined scenarios)

## Task Commits

Each task was committed atomically:

1. **Task 1: Add timing columns to test_result table and regenerate JOOQ** - `0ed6503` (feat)
   - Added start_time and end_time DATETIME NULL columns to test_result DDL
   - Applied schema change to both local MySQL and RDS
   - Regenerated JOOQ TestResultTable, TestResultRecord, TestResultDao, TestResultPojo

2. **Task 2: Create updateTestResultTiming persistence method** - `d6d8995` (feat)
   - Added updateTestResultTiming method to StagePathPersistService
   - Uses TEST_RESULT.START_TIME and TEST_RESULT.END_TIME JOOQ fields
   - Same null-handling and logging patterns as updateRunTiming

3. **Task 3: Update controller to use testResultId and new persistence method** - `43eb780` (feat)
   - Changed data flow from runId to testResultId
   - Updated processKarateTiming method signature and all log messages
   - Changed service call from updateRunTiming to updateTestResultTiming

## Files Created/Modified
- `reportcard-server/src/main/resources/db/migration/V1.0__reportcard_mysql_ddl.sql` - Added timing columns to test_result table
- `reportcard-server/src/generated/java/io/github/ericdriggs/reportcard/gen/db/tables/TestResultTable.java` - START_TIME and END_TIME fields (generated)
- `reportcard-server/src/generated/java/io/github/ericdriggs/reportcard/gen/db/tables/records/TestResultRecord.java` - Timing accessors (generated)
- `reportcard-server/src/generated/java/io/github/ericdriggs/reportcard/gen/db/tables/daos/TestResultDao.java` - Updated DAO (generated)
- `reportcard-server/src/generated/java/io/github/ericdriggs/reportcard/gen/db/tables/pojos/TestResultPojo.java` - Updated POJO (generated)
- `reportcard-server/src/main/java/io/github/ericdriggs/reportcard/persist/StagePathPersistService.java` - Added updateTestResultTiming method
- `reportcard-server/src/main/java/io/github/ericdriggs/reportcard/controller/JunitController.java` - Updated to use testResultId

## Decisions Made

**Additive-only migration:** Kept run.start_time/end_time columns. This allows rollback if issues discovered and maintains backward compatibility. Can be removed in future cleanup phase after production validation.

**No dual-write:** New uploads write only to test_result.start_time/end_time. The run columns will become stale immediately. This simplifies implementation and testing vs. maintaining dual-write logic.

**Column positioning:** Placed new columns after existing `time` column (sum of test durations) since all three are timing-related, creating logical grouping.

## Deviations from Plan

### Auto-fixed Issues

**1. [Rule 3 - Blocking] Local MySQL schema update required for JOOQ regeneration**
- **Found during:** Task 1 (JOOQ regeneration)
- **Issue:** Initial JOOQ regeneration used environment variable DB connection (RDS) where schema was updated, but JOOQ task in build.gradle connects to localhost:3306. Generated classes were unchanged because local MySQL lacked new columns.
- **Fix:** Applied same ALTER TABLE to local MySQL before re-running JOOQ generation
- **Files modified:** Local MySQL database (no code change)
- **Verification:** JOOQ TestResultTable.java now contains START_TIME and END_TIME fields
- **Committed in:** 0ed6503 (Task 1 commit)

---

**Total deviations:** 1 auto-fixed (blocking issue)
**Impact on plan:** Minor workflow adjustment. Local MySQL must be updated before JOOQ regeneration (same pattern documented in Phase 1). No scope creep.

## Issues Encountered

**Pre-existing test isolation issue:** Two tests (JunitControllerTest.postJunitHtmlSurefireFormat and postJunitHtmlJunitFormat) fail when run in full test suite but pass when run individually. This is a pre-existing issue documented in STATE.md and unrelated to timing migration changes. All Karate-specific tests pass.

**Javadoc generation failure:** Full `./gradlew build` fails on javadoc task in reportcard-client module (pre-existing issue). Compile and test tasks succeed.

## User Setup Required

None - no external service configuration required. Both local MySQL and RDS databases were updated as part of Task 1.

## Next Phase Readiness

**Ready for downstream work:**
- Per-stage timing now available via test_result.start_time/end_time
- Multi-stage runs can have independent timing per stage
- JOOQ provides type-safe Instant accessors
- Existing JUnit-only uploads continue working (timing columns are NULL)

**Backward compatibility notes:**
- run.start_time/end_time columns still exist but are no longer populated by new uploads
- updateRunTiming method still exists for any external callers (none found in codebase)
- Consider removal of run timing columns in future cleanup phase

**No blockers or concerns for next phases.**

---
*Phase: 04.1-migrate-timing-to-test-result*
*Completed: 2026-01-27*
