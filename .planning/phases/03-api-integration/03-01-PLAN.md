---
phase: 03-api-integration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - reportcard-server/src/main/java/io/github/ericdriggs/reportcard/controller/util/KarateTarGzUtil.java
  - reportcard-server/src/main/java/io/github/ericdriggs/reportcard/controller/model/JunitHtmlPostRequest.java
  - reportcard-server/src/main/java/io/github/ericdriggs/reportcard/persist/StagePathPersistService.java
  - reportcard-server/src/test/java/io/github/ericdriggs/reportcard/controller/util/KarateTarGzUtilTest.java
autonomous: true

must_haves:
  truths:
    - "KarateTarGzUtil extracts karate-summary-json.txt from tar.gz archives"
    - "JunitHtmlPostRequest accepts optional karateTarGz field"
    - "StagePathPersistService can update run timing (start_time, end_time)"
    - "Temp directories are cleaned up after extraction"
  artifacts:
    - path: "reportcard-server/src/main/java/io/github/ericdriggs/reportcard/controller/util/KarateTarGzUtil.java"
      provides: "Karate tar.gz extraction utility"
      exports: ["extractKarateSummaryJson"]
    - path: "reportcard-server/src/main/java/io/github/ericdriggs/reportcard/controller/model/JunitHtmlPostRequest.java"
      provides: "Request model with karateTarGz field"
      contains: "MultipartFile karateTarGz"
    - path: "reportcard-server/src/main/java/io/github/ericdriggs/reportcard/persist/StagePathPersistService.java"
      provides: "Run timing update method"
      contains: "updateRunTiming"
  key_links:
    - from: "KarateTarGzUtil"
      to: "TarExtractorCommonsCompress"
      via: "tar extraction"
      pattern: "TarExtractorCommonsCompress"
    - from: "StagePathPersistService.updateRunTiming"
      to: "RUN table"
      via: "JOOQ DSL update"
      pattern: "dsl\\.update\\(RUN\\)"
---

<objective>
Create infrastructure components for Karate JSON upload support.

Purpose: Establish the utility classes, request model, and persistence method that the controller will use to process karate.tar.gz uploads and persist timing data.

Output:
- KarateTarGzUtil: Extracts karate-summary-json.txt from tar.gz
- JunitHtmlPostRequest: Updated with karateTarGz field
- StagePathPersistService: updateRunTiming() method for start_time/end_time
- Unit test for KarateTarGzUtil
</objective>

<execution_context>
@/Users/eric.r.driggs/.claude/get-shit-done/workflows/execute-plan.md
@/Users/eric.r.driggs/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-api-integration/03-RESEARCH.md

# Existing patterns to follow
@reportcard-server/src/main/java/io/github/ericdriggs/reportcard/controller/util/TestXmlTarGzUtil.java
@reportcard-server/src/main/java/io/github/ericdriggs/reportcard/persist/StagePathPersistService.java
@reportcard-server/src/main/java/io/github/ericdriggs/reportcard/controller/model/JunitHtmlPostRequest.java
@reportcard-model/src/main/java/io/github/ericdriggs/reportcard/model/converter/karate/KarateConvertersUtil.java
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create KarateTarGzUtil extraction utility</name>
  <files>
    reportcard-server/src/main/java/io/github/ericdriggs/reportcard/controller/util/KarateTarGzUtil.java
    reportcard-server/src/test/java/io/github/ericdriggs/reportcard/controller/util/KarateTarGzUtilTest.java
  </files>
  <action>
Create KarateTarGzUtil in same package as TestXmlTarGzUtil. Follow the exact enum pattern from TestXmlTarGzUtil.

Implementation:
```java
package io.github.ericdriggs.reportcard.controller.util;

public enum KarateTarGzUtil {
    ;//static methods only

    private static final String KARATE_SUMMARY_FILENAME = "karate-summary-json.txt";

    @SneakyThrows(IOException.class)
    public static String extractKarateSummaryJson(MultipartFile tarGz) {
        if (tarGz == null || tarGz.isEmpty()) {
            return null;
        }
        Path tempDir = Files.createTempDirectory("reportcard-karate-");
        try {
            InputStream inputStream = tarGz.getInputStream();
            TarExtractorCommonsCompress tarExtractor =
                new TarExtractorCommonsCompress(inputStream, true, tempDir);
            tarExtractor.untar();

            // Find karate-summary-json.txt recursively (may be in subdirectory)
            return FileUtils.fileContentsFromPathAndRegex(tempDir, KARATE_SUMMARY_FILENAME)
                .stream()
                .findFirst()
                .orElse(null);
        } finally {
            if (tempDir != null) {
                org.apache.tomcat.util.http.fileupload.FileUtils.deleteDirectory(tempDir.toFile());
            }
        }
    }
}
```

Required imports:
- io.github.ericdriggs.file.FileUtils
- io.github.ericdriggs.reportcard.util.tar.TarExtractorCommonsCompress
- lombok.SneakyThrows
- org.springframework.web.multipart.MultipartFile
- java.io.IOException, java.io.InputStream
- java.nio.file.Files, java.nio.file.Path

Create unit test KarateTarGzUtilTest:
- Test extractKarateSummaryJson with null input returns null
- Test extractKarateSummaryJson with empty file returns null
- Test extractKarateSummaryJson with valid tar.gz containing karate-summary-json.txt returns content

Use TestXmlTarGzUtil.createTarGzipFilesForTesting() pattern to create test tar.gz with a mock karate-summary-json.txt file.
  </action>
  <verify>
    ./gradlew :reportcard-server:test --tests "io.github.ericdriggs.reportcard.controller.util.KarateTarGzUtilTest" --info
  </verify>
  <done>
    KarateTarGzUtil.extractKarateSummaryJson() extracts content from tar.gz, returns null for invalid input, cleans up temp directory
  </done>
</task>

<task type="auto">
  <name>Task 2: Update JunitHtmlPostRequest and add updateRunTiming persistence method</name>
  <files>
    reportcard-server/src/main/java/io/github/ericdriggs/reportcard/controller/model/JunitHtmlPostRequest.java
    reportcard-server/src/main/java/io/github/ericdriggs/reportcard/persist/StagePathPersistService.java
  </files>
  <action>
**Update JunitHtmlPostRequest:**

Add karateTarGz field to existing @Builder @Value class:

```java
@Builder
@Jacksonized
@Value
public class JunitHtmlPostRequest {
    StageDetails stageDetails;
    String label;
    String indexFile;
    MultipartFile junitXmls;
    MultipartFile karateTarGz;  // NEW: optional karate tar.gz
    MultipartFile reports;
}
```

**Add updateRunTiming to StagePathPersistService:**

Add this method to StagePathPersistService (follow existing dsl.update pattern from setIsRunSuccess):

```java
/**
 * Updates run record with start and end times from Karate timing data.
 * Does nothing if both times are null.
 *
 * @param runId the run ID to update
 * @param startTime the start time (nullable)
 * @param endTime the end time (nullable)
 */
public void updateRunTiming(Long runId, Instant startTime, Instant endTime) {
    if (runId == null) {
        log.warn("Cannot update run timing: runId is null");
        return;
    }
    if (startTime == null && endTime == null) {
        log.debug("No timing data to update for runId: {}", runId);
        return;
    }

    int rowsUpdated = dsl.update(RUN)
            .set(RUN.START_TIME, startTime)
            .set(RUN.END_TIME, endTime)
            .where(RUN.RUN_ID.eq(runId))
            .execute();

    if (rowsUpdated != 1) {
        log.warn("Expected 1 row updated for run timing, actual: {} for runId: {}", rowsUpdated, runId);
    }
}
```

Required import for StagePathPersistService: java.time.Instant (already imported, verify)
  </action>
  <verify>
    ./gradlew :reportcard-server:compileJava
  </verify>
  <done>
    JunitHtmlPostRequest has karateTarGz field, StagePathPersistService has updateRunTiming method, code compiles
  </done>
</task>

</tasks>

<verification>
1. KarateTarGzUtil unit tests pass: `./gradlew :reportcard-server:test --tests "*KarateTarGzUtilTest*"`
2. All server code compiles: `./gradlew :reportcard-server:compileJava :reportcard-server:compileTestJava`
3. Existing tests still pass: `./gradlew :reportcard-server:test`
</verification>

<success_criteria>
1. KarateTarGzUtil.extractKarateSummaryJson() extracts karate-summary-json.txt content from tar.gz
2. KarateTarGzUtil returns null for null/empty input without throwing exceptions
3. KarateTarGzUtil cleans up temp directories (no disk space leak)
4. JunitHtmlPostRequest.karateTarGz field exists and is accessible via getter
5. StagePathPersistService.updateRunTiming() updates RUN.START_TIME and RUN.END_TIME
6. All existing tests continue to pass (no regressions)
</success_criteria>

<output>
After completion, create `.planning/phases/03-api-integration/03-01-SUMMARY.md`
</output>
