---
phase: 01-foundation-validation
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - reportcard-server/src/test/java/io/github/ericdriggs/reportcard/controller/browse/BrowseJsonControllerTest.java
autonomous: true

must_haves:
  truths:
    - "User can call branch-level endpoint and receive JSON with jobs and runs"
    - "User can call job-level endpoint and receive JSON with runs and stages"
    - "User can call run-level endpoint and receive JSON with stages and test results"
    - "User can call stage-detail endpoint and receive JSON with test suites and test cases"
    - "User can observe valid JSON structure for all job/run/stage endpoints"
  artifacts:
    - path: "reportcard-server/src/test/java/io/github/ericdriggs/reportcard/controller/browse/BrowseJsonControllerTest.java"
      provides: "Integration tests for job/run/stage JSON endpoints"
      min_lines: 300
  key_links:
    - from: "BrowseJsonControllerTest job/run tests"
      to: "BrowseJsonController job/run methods"
      via: "controller.getBranchJobsRuns(), getJobRunsStages(), getStagesByIds(), getStageTestResultsTestSuites()"
      pattern: "controller\\.get.*Job|Run|Stage"
---

<objective>
Add integration tests for BrowseJsonController job, run, and stage endpoints.

Purpose: Complete validation of deeper hierarchy levels (branch → job → run → stage) to ensure JSON serialization works end-to-end.

Output: 4 additional test methods in BrowseJsonControllerTest covering job, run, and stage endpoints.
</objective>

<execution_context>
@/Users/eric.r.driggs/.claude/get-shit-done/workflows/execute-plan.md
@/Users/eric.r.driggs/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-foundation-validation/01-CONTEXT.md
@.planning/phases/01-foundation-validation/01-RESEARCH.md

@reportcard-server/src/test/java/io/github/ericdriggs/reportcard/controller/browse/BrowseJsonControllerTest.java
@reportcard-server/src/test/java/io/github/ericdriggs/reportcard/persist/browse/BrowseServiceTest.java
@reportcard-server/src/main/java/io/github/ericdriggs/reportcard/controller/browse/BrowseJsonController.java
</context>

<tasks>

<task type="auto">
  <name>Add job/run/stage endpoint tests to BrowseJsonControllerTest</name>
  <files>reportcard-server/src/test/java/io/github/ericdriggs/reportcard/controller/browse/BrowseJsonControllerTest.java</files>
  <action>
Add success tests for these 4 endpoints to existing BrowseJsonControllerTest class:

1. getBranchJobsRuns(company, org, repo, branch, jobInfoFilters) - branch level
   - Pass null for jobInfoFilters (not implemented yet per research)
   - Returns Map<BranchPojo, Map<JobPojo, Set<RunPojo>>>
   - Verify branch matches TestData.branch
   - Verify jobId matches TestData.jobId
   - Verify at least one run exists

2. getJobRunsStages(company, org, repo, branch, jobId) - job level
   - Use TestData.jobId
   - Returns Map<JobPojo, Map<RunPojo, Set<StagePojo>>>
   - Verify job matches TestData.jobId
   - Verify at least one run and stage exist
   - Verify stage name matches TestData.stage

3. getStagesByIds(company, org, repo, branch, jobId, runId) - run level
   - Use TestData.jobId and derive runId from previous query or use known ID 1L
   - Returns Map<RunPojo, Map<StagePojo, Set<TestResultPojo>>>
   - Verify run exists
   - Verify stages contain TestData.stage
   - Verify test results are present

4. getStageTestResultsTestSuites(company, org, repo, branch, jobId, runId, stage) - stage detail
   - Use TestData constants for all path variables
   - Returns StageTestResultModel
   - Verify response is not null
   - Verify stage details contain test suites
   - Verify test suites contain test cases

For each test, follow the same pattern as Plan 01:
- Assert HttpStatus.OK
- Assert body is not null
- Assert body is not empty
- Verify expected test data appears

DO NOT test error cases - those are in Plan 03.
  </action>
  <verify>
./gradlew test --tests "io.github.ericdriggs.reportcard.controller.browse.BrowseJsonControllerTest"

All 8 tests pass (4 from Plan 01 + 4 new tests).
  </verify>
  <done>
BrowseJsonControllerTest contains 8 passing tests total - 4 hierarchy tests and 4 job/run/stage tests.
Each new test validates HTTP 200 status, non-null body, non-empty response, and expected test data presence.
All endpoints from company level down to stage detail are validated.
  </done>
</task>

</tasks>

<verification>
Run full test suite to ensure no regressions:
```bash
./gradlew test --tests "*BrowseJsonControllerTest"
./gradlew test --tests "*BrowseServiceTest"
```

Expected: All tests pass with no failures.
</verification>

<success_criteria>
1. BrowseJsonControllerTest contains 8 test methods total
2. New tests: getBranchJobsRunsJsonSuccessTest, getJobRunsStagesJsonSuccessTest, getStagesByIdsJsonSuccessTest, getStageTestResultsTestSuitesJsonSuccessTest
3. All new tests call controller methods with TestData constants
4. All new tests pass null for jobInfoFilters where applicable
5. All new tests verify HTTP 200 status code
6. All new tests verify response body is non-null and non-empty
7. All new tests verify expected TestData constants appear in response
8. Test execution completes successfully with ./gradlew test
9. No regressions in existing BrowseServiceTest
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-validation/01-02-SUMMARY.md` following the summary template.
</output>
