---
phase: 01-foundation-validation
plan: 03
type: execute
wave: 2
depends_on: ["01-01", "01-02"]
files_modified:
  - reportcard-server/src/test/java/io/github/ericdriggs/reportcard/controller/browse/BrowseJsonControllerTest.java
autonomous: true

must_haves:
  truths:
    - "User can call SHA lookup endpoints and receive JSON with runs for specific commit"
    - "User can call SHA + run reference endpoint and receive single run JSON"
    - "User can observe 404 errors with descriptive messages when entities not found"
    - "User can observe 404 errors when parent entities are missing in hierarchy"
    - "User can confirm error messages follow hierarchical format"
  artifacts:
    - path: "reportcard-server/src/test/java/io/github/ericdriggs/reportcard/controller/browse/BrowseJsonControllerTest.java"
      provides: "Complete test coverage including SHA lookups and error cases"
      min_lines: 450
  key_links:
    - from: "BrowseJsonControllerTest SHA tests"
      to: "BrowseJsonController SHA methods"
      via: "controller.getRuns(), getRunForReference()"
      pattern: "controller\\.get.*sha|runReference"
    - from: "BrowseJsonControllerTest error tests"
      to: "BrowseService error handling"
      via: "ResponseStatusException propagation"
      pattern: "assertThrows.*ResponseStatusException"
---

<objective>
Add SHA lookup endpoint tests and comprehensive error case validation to BrowseJsonControllerTest.

Purpose: Complete Phase 1 validation by testing remaining endpoints (SHA lookups) and verifying error handling follows consistent patterns across all hierarchy levels.

Output: Complete BrowseJsonControllerTest with success tests for all 10 endpoints plus error case validation.
</objective>

<execution_context>
@/Users/eric.r.driggs/.claude/get-shit-done/workflows/execute-plan.md
@/Users/eric.r.driggs/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-foundation-validation/01-CONTEXT.md
@.planning/phases/01-foundation-validation/01-RESEARCH.md

@reportcard-server/src/test/java/io/github/ericdriggs/reportcard/controller/browse/BrowseJsonControllerTest.java
@reportcard-server/src/test/java/io/github/ericdriggs/reportcard/persist/browse/BrowseServiceTest.java
@reportcard-server/src/main/java/io/github/ericdriggs/reportcard/controller/browse/BrowseJsonController.java
</context>

<tasks>

<task type="auto">
  <name>Add SHA lookup endpoint tests to BrowseJsonControllerTest</name>
  <files>reportcard-server/src/test/java/io/github/ericdriggs/reportcard/controller/browse/BrowseJsonControllerTest.java</files>
  <action>
Add success tests for the 2 SHA lookup endpoints:

1. getRuns(company, org, repo, branch, sha, jobInfoFilters) - SHA lookup
   - Use TestData.sha constant
   - Pass null for jobInfoFilters
   - Returns Map<BranchPojo, Map<JobPojo, Set<RunPojo>>>
   - Verify runs are returned for the specific SHA
   - Verify at least one run matches TestData.sha

2. getRunForReference(company, org, repo, branch, sha, runReference, metadataFilters) - SHA + run reference
   - Use TestData.sha and TestData.runReference
   - Pass null for metadataFilters
   - Returns RunPojo (single object, not a collection)
   - Verify run is not null
   - Verify run.getSha() matches TestData.sha

Follow same success pattern as previous plans:
- Assert HttpStatus.OK
- Assert body is not null
- Verify expected test data appears
  </action>
  <verify>
./gradlew test --tests "io.github.ericdriggs.reportcard.controller.browse.BrowseJsonControllerTest" --tests "*Sha*"

New SHA tests pass successfully.
  </verify>
  <done>
BrowseJsonControllerTest contains success tests for all 10 JSON endpoints including 2 SHA lookup endpoints.
  </done>
</task>

<task type="auto">
  <name>Add error case validation tests to BrowseJsonControllerTest</name>
  <files>reportcard-server/src/test/java/io/github/ericdriggs/reportcard/controller/browse/BrowseJsonControllerTest.java</files>
  <action>
Add error case tests following BrowseServiceTest patterns from research.

CRITICAL: Per research findings, BrowseJsonController does NOT have @ExceptionHandler methods. ResponseStatusException propagates from service layer to Spring's global exception handling. Test error cases by calling browseService methods directly (not controller methods) and catching ResponseStatusException.

Add at least 5 error tests covering:

1. Missing org - call browseService.getOrg(TestData.company, "MISSING_ORG")
   - assertThrows(ResponseStatusException.class)
   - Verify ex.getStatus().value() == 404
   - Verify ex.getMessage() contains TestData.company and "MISSING_ORG"

2. Missing repo with missing parent org - call browseService.getRepo(TestData.company, "MISSING_ORG", "MISSING_REPO")
   - Verify 404 status
   - Verify message contains all three parts: company, org, repo

3. Missing branch - call browseService.getBranch(TestData.company, TestData.org, TestData.repo, "MISSING_BRANCH")
   - Verify 404 status
   - Verify hierarchical error message format

4. Invalid SHA - call browseService method with non-existent SHA value
   - Verify appropriate error response

5. Missing run reference - use valid SHA but invalid runReference UUID
   - Verify 404 status

Follow exact pattern from BrowseServiceTest.getOrgNotFoundTest (lines 52-61 in research).

DO NOT test controller exception handling directly - controller is pass-through.
Test at service layer where ResponseStatusException is thrown.
  </action>
  <verify>
./gradlew test --tests "io.github.ericdriggs.reportcard.controller.browse.BrowseJsonControllerTest" --tests "*NotFound*"

All error tests pass successfully.
  </verify>
  <done>
BrowseJsonControllerTest contains comprehensive error validation with at least 5 error tests verifying 404 status codes and hierarchical error message formats.
Error tests validate ResponseStatusException behavior from service layer.
  </done>
</task>

</tasks>

<verification>
Run full test suite to ensure complete coverage:
```bash
./gradlew test --tests "*BrowseJsonControllerTest"
./gradlew test --tests "*BrowseServiceTest"
```

Expected: All tests pass (at least 15 total tests in BrowseJsonControllerTest: 10 success + 5 error).
</verification>

<success_criteria>
1. BrowseJsonControllerTest contains at least 15 test methods total
2. All 10 JSON endpoints have success test coverage
3. At least 5 error tests validate 404 scenarios
4. Error tests call browseService methods directly (not controller)
5. Error tests verify ResponseStatusException with 404 status
6. Error tests verify hierarchical error message format contains all path segments
7. SHA lookup tests use TestData.sha and TestData.runReference constants
8. All tests pass successfully with ./gradlew test
9. No regressions in existing BrowseServiceTest
10. Phase 1 requirements API-02, TEST-01, TEST-02 are satisfied
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-validation/01-03-SUMMARY.md` following the summary template.
</output>
