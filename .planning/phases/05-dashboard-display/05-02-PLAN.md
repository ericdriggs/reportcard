---
phase: 05-dashboard-display
plan: 02
type: execute
wave: 2
depends_on: ["05-01"]
files_modified:
  - reportcard-server/src/main/java/io/github/ericdriggs/reportcard/controller/graph/PipelineDashboardHtmlHelper.java
autonomous: true

must_haves:
  truths:
    - "Pipelines dashboard table has 'Avg Run Duration' column after 'Test Pass %'"
    - "Duration displays in human-readable format (XXh XXm XXs)"
    - "NULL duration displays as dash '-' character"
    - "Duration column sorts correctly (lexical with transparent padding)"
    - "Field description explains Avg Run Duration metric"
  artifacts:
    - path: "reportcard-server/src/main/java/io/github/ericdriggs/reportcard/controller/graph/PipelineDashboardHtmlHelper.java"
      provides: "Avg Run Duration column rendering"
      contains: "Avg Run Duration"
    - path: "reportcard-server/src/main/java/io/github/ericdriggs/reportcard/controller/graph/PipelineDashboardHtmlHelper.java"
      provides: "formatDuration helper method"
      pattern: "formatDuration.*BigDecimal"
  key_links:
    - from: "reportcard-server/src/main/java/io/github/ericdriggs/reportcard/controller/graph/PipelineDashboardHtmlHelper.java"
      to: "NumberStringUtil.fromSecondBigDecimalPadded"
      via: "formatDuration method call"
      pattern: "NumberStringUtil\\.fromSecondBigDecimalPadded"
    - from: "reportcard-server/src/main/java/io/github/ericdriggs/reportcard/controller/graph/PipelineDashboardHtmlHelper.java"
      to: "JobDashboardMetrics.getAvgRunDuration()"
      via: "table cell rendering"
      pattern: "metric\\.getAvgRunDuration\\(\\)"
---

<objective>
Display average run duration in the pipelines dashboard by adding a new column with formatted timing data.

Purpose: Make job execution wall clock time visible to users in the dashboard table, enabling them to see how long CI jobs actually take beyond just test pass rates.

Output: Updated HTML table with "Avg Run Duration" column showing formatted durations with proper NULL handling and sortability.
</objective>

<execution_context>
@/Users/eric.r.driggs/.claude/get-shit-done/workflows/execute-plan.md
@/Users/eric.r.driggs/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@/Users/eric.r.driggs/github/ericdriggs/reportcard/.planning/PROJECT.md
@/Users/eric.r.driggs/github/ericdriggs/reportcard/.planning/ROADMAP.md
@/Users/eric.r.driggs/github/ericdriggs/reportcard/.planning/STATE.md
@/Users/eric.r.driggs/github/ericdriggs/reportcard/.planning/phases/05-dashboard-display/05-CONTEXT.md
@/Users/eric.r.driggs/github/ericdriggs/reportcard/.planning/phases/05-dashboard-display/05-RESEARCH.md

# Dependency on Plan 01
@/Users/eric.r.driggs/github/ericdriggs/reportcard/.planning/phases/05-dashboard-display/05-01-PLAN.md

# Relevant source files
@/Users/eric.r.driggs/github/ericdriggs/reportcard/reportcard-server/src/main/java/io/github/ericdriggs/reportcard/controller/graph/PipelineDashboardHtmlHelper.java
@/Users/eric.r.driggs/github/ericdriggs/reportcard/reportcard-model/src/main/java/io/github/ericdriggs/reportcard/util/NumberStringUtil.java
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add formatDuration helper method</name>
  <files>
reportcard-server/src/main/java/io/github/ericdriggs/reportcard/controller/graph/PipelineDashboardHtmlHelper.java
  </files>
  <action>
Add a private helper method `formatDuration` to PipelineDashboardHtmlHelper class, positioned near the bottom of the class after `renderPipelineTable` method.

**Method signature and implementation:**
```java
private static String formatDuration(BigDecimal durationSeconds) {
    if (durationSeconds == null) {
        return "-";  // Per CONTEXT.md requirement DISP-03
    }
    return NumberStringUtil.fromSecondBigDecimalPadded(durationSeconds);
}
```

**Why this helper:**
- Centralizes NULL handling per DISP-03 requirement (show "-" for missing timing)
- Reuses existing NumberStringUtil.fromSecondBigDecimalPadded which provides:
  - Human-readable format (XXh XXm XXs)
  - Transparent padding for correct lexical sorting in HTML tables
  - Handles all time units (seconds, minutes, hours, days, years)

**Import to add:**
```java
import java.math.BigDecimal;
```
(Check if BigDecimal is already imported via other usages)

**Note:** NumberStringUtil is already statically imported at the top of this file (`import static io.github.ericdriggs.reportcard.util.NumberStringUtil.*;`), so fromSecondBigDecimalPadded can be called directly without class prefix, but keeping it explicit for clarity.
  </action>
  <verify>
1. Method compiles without errors
2. Grep confirms method exists:
   ```bash
   grep -n "formatDuration" reportcard-server/src/main/java/io/github/ericdriggs/reportcard/controller/graph/PipelineDashboardHtmlHelper.java
   ```
3. NULL check present before calling NumberStringUtil
  </verify>
  <done>
- formatDuration method exists in PipelineDashboardHtmlHelper
- Returns "-" for null input
- Returns formatted duration string for non-null input using NumberStringUtil.fromSecondBigDecimalPadded
- BigDecimal import present (if not already imported)
  </done>
</task>

<task type="auto">
  <name>Task 2: Add "Avg Run Duration" column to table</name>
  <files>
reportcard-server/src/main/java/io/github/ericdriggs/reportcard/controller/graph/PipelineDashboardHtmlHelper.java
  </files>
  <action>
Modify the `renderPipelineTable` method to add a new column for average run duration.

**1. Add table header (in `<thead>` section, around line 127):**

After the "Test Pass %" header line, add:
```java
sb.append("<th>Avg Run Duration</th>").append(ls);
```

Position: Right after line 127 (`sb.append("<th>Test Pass %</th>").append(ls);`)

**2. Add table data cell (in `<tbody>` loop, around line 153):**

After the Test Pass % cell rendering, add:
```java
sb.append("<td>").append(formatDuration(metric.getAvgRunDuration())).append("</td>").append(ls);
```

Position: Right after line 153 (`sb.append("<td class='percent'>").append(percentFromBigDecimal(metric.getTestPassPercent())).append("</td>").append(ls);`)

**Why this placement:**
- CONTEXT.md specifies: "add 'Avg Run Duration' column after Test Pass %"
- Follows existing pattern for rendering cells (td wrapping formatted value)
- Uses formatDuration helper which handles NULL and formatting

**Note:** Do NOT add `class='percent'` to the duration cell. Duration is not a percentage, and the existing CSS class might interfere with display. Use plain `<td>` like the "Days since SUCCESS" column.
  </action>
  <verify>
1. Build succeeds:
   ```bash
   ./gradlew build
   ```
2. Grep confirms header added:
   ```bash
   grep -n "Avg Run Duration" reportcard-server/src/main/java/io/github/ericdriggs/reportcard/controller/graph/PipelineDashboardHtmlHelper.java
   ```
3. Grep confirms data cell uses formatDuration:
   ```bash
   grep -n "formatDuration.*getAvgRunDuration" reportcard-server/src/main/java/io/github/ericdriggs/reportcard/controller/graph/PipelineDashboardHtmlHelper.java
   ```
4. Column appears after Test Pass % (verify line numbers)
  </verify>
  <done>
- Table header includes "Avg Run Duration" column after "Test Pass %"
- Table body renders duration using formatDuration(metric.getAvgRunDuration())
- Column positioned correctly in both header and body
- Build succeeds with no compilation errors
  </done>
</task>

<task type="auto">
  <name>Task 3: Add field description for Avg Run Duration</name>
  <files>
reportcard-server/src/main/java/io/github/ericdriggs/reportcard/controller/graph/PipelineDashboardHtmlHelper.java
  </files>
  <action>
Update the "Field Descriptions" fieldset at the bottom of the table to document the new Avg Run Duration column.

**Location:** In `renderPipelineTable` method, within the `<dl>` definition list (around line 161-167).

**Add after the "Test Pass %" description:**

```java
sb.append("<dt style='display: table-cell; border: 1px solid #ccc; padding: 8px; font-weight: bold; background: #f5f5f5;'>Avg Run Duration</dt>").append(ls);
sb.append("<dd style='display: table-cell; border: 1px solid #ccc; padding: 8px; margin: 0;'>Average wall clock execution time per run. Calculated as the sum of all test_result stage timings for each run, then averaged across runs with timing data. Displays \"-\" for jobs without timing data.</dd>").append(ls);
```

Position: Right after the Test Pass % `<dd>` closing tag (after line 167).

**Why this description:**
- Explains the metric clearly to users
- Clarifies aggregation strategy (sum stages, then average runs)
- Documents NULL handling ("-" display)
- Follows existing pattern of dt/dd pairs in the definition list
- Matches style attributes of existing descriptions

**Note:** The existing fieldset uses display: table-cell for dt/dd to create a table-like layout. Follow the same pattern for visual consistency.
  </action>
  <verify>
1. Build succeeds
2. Grep confirms description added:
   ```bash
   grep -n "Average wall clock execution time" reportcard-server/src/main/java/io/github/ericdriggs/reportcard/controller/graph/PipelineDashboardHtmlHelper.java
   ```
3. Description follows existing dt/dd pattern
4. All inline styles match existing descriptions
  </verify>
  <done>
- Field Descriptions section includes entry for "Avg Run Duration"
- Description explains wall clock timing, aggregation strategy, and NULL handling
- Formatting matches existing descriptions (dt/dd with table-cell display)
- Build succeeds
  </done>
</task>

</tasks>

<verification>
**Integration verification:**

1. Build succeeds with no compilation errors:
   ```bash
   ./gradlew build
   ```

2. Verify all three changes present:
   ```bash
   # formatDuration method
   grep -A 5 "formatDuration.*BigDecimal" reportcard-server/src/main/java/io/github/ericdriggs/reportcard/controller/graph/PipelineDashboardHtmlHelper.java

   # Table header
   grep -n "Avg Run Duration" reportcard-server/src/main/java/io/github/ericdriggs/reportcard/controller/graph/PipelineDashboardHtmlHelper.java | head -1

   # Table cell
   grep -n "formatDuration.*getAvgRunDuration" reportcard-server/src/main/java/io/github/ericdriggs/reportcard/controller/graph/PipelineDashboardHtmlHelper.java

   # Field description
   grep -n "Average wall clock execution time" reportcard-server/src/main/java/io/github/ericdriggs/reportcard/controller/graph/PipelineDashboardHtmlHelper.java
   ```

3. Run any existing PipelineDashboardHtmlHelper tests:
   ```bash
   ./gradlew test --tests "*PipelineDashboardHtmlHelper*"
   ```

**Manual verification checkpoint:**
See next task for human verification of rendered HTML.
</verification>

<success_criteria>
- PipelineDashboardHtmlHelper has formatDuration helper method
- formatDuration returns "-" for NULL, calls NumberStringUtil.fromSecondBigDecimalPadded otherwise
- Table header includes "Avg Run Duration" after "Test Pass %"
- Table body renders metric.getAvgRunDuration() using formatDuration
- Field Descriptions section documents the new column
- Build succeeds, all existing tests pass
- Column positioned correctly in table structure
</success_criteria>

<output>
After completion, create `.planning/phases/05-dashboard-display/05-02-SUMMARY.md` following the template structure with performance metrics, accomplishments, decisions made, and files modified.
</output>
