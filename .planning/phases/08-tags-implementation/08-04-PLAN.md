---
phase: 08-tags-implementation
plan: 04
type: tdd
wave: 2
depends_on: ["08-01"]
files_modified:
  - reportcard-server/src/main/java/io/github/ericdriggs/reportcard/persist/tags/TagExpressionParser.java
  - reportcard-server/src/main/java/io/github/ericdriggs/reportcard/persist/tags/TagExpr.java
  - reportcard-server/src/test/java/io/github/ericdriggs/reportcard/persist/tags/TagExpressionParserTest.java
autonomous: true

must_haves:
  truths:
    - "Parser tokenizes tag expressions into identifiers and operators"
    - "Parser builds AST respecting AND > OR precedence"
    - "Parentheses override default precedence"
    - "Invalid expressions throw ParseException"
  artifacts:
    - path: "reportcard-server/src/main/java/io/github/ericdriggs/reportcard/persist/tags/TagExpressionParser.java"
      provides: "Recursive descent parser"
      exports: ["parse"]
    - path: "reportcard-server/src/main/java/io/github/ericdriggs/reportcard/persist/tags/TagExpr.java"
      provides: "AST node types"
      exports: ["TagExpr", "SimpleTag", "AndExpr", "OrExpr"]
    - path: "reportcard-server/src/test/java/io/github/ericdriggs/reportcard/persist/tags/TagExpressionParserTest.java"
      provides: "Parser unit tests"
      min_lines: 150
  key_links:
    - from: "TagExpressionParser.java"
      to: "TagExpr.java"
      via: "returns AST nodes"
      pattern: "return new (SimpleTag|AndExpr|OrExpr)"
---

<objective>
Implement boolean expression parser for tag queries using TDD approach.

Purpose: Tag queries support boolean syntax like "(smoke OR regression) AND env=prod". The parser converts this string into an AST that can be transformed to SQL.

Output: TagExpressionParser class with recursive descent implementation, TagExpr AST node hierarchy, and comprehensive unit tests.
</objective>

<execution_context>
@/Users/eric.r.driggs/.claude/get-shit-done/workflows/execute-plan.md
@/Users/eric.r.driggs/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/07-tags-investigation/07-03-API-DESIGN.md
@.planning/phases/07-tags-investigation/07-RESEARCH.md
</context>

<feature>
  <name>TagExpressionParser</name>
  <files>
    reportcard-server/src/main/java/io/github/ericdriggs/reportcard/persist/tags/TagExpressionParser.java
    reportcard-server/src/main/java/io/github/ericdriggs/reportcard/persist/tags/TagExpr.java
    reportcard-server/src/test/java/io/github/ericdriggs/reportcard/persist/tags/TagExpressionParserTest.java
  </files>
  <behavior>
    Grammar (standard boolean expression with AND > OR precedence):
    ```
    expr     := term (OR term)*
    term     := factor (AND factor)*
    factor   := TAG | ( expr )
    TAG      := identifier | identifier=value
    ```

    Precedence: AND binds tighter than OR (standard boolean algebra)
    - "a OR b AND c" parses as "a OR (b AND c)"
    - Parentheses override: "(a OR b) AND c"

    Test cases (input -> AST structure):
    - "smoke" -> SimpleTag("smoke")
    - "env=prod" -> SimpleTag("env=prod")
    - "smoke AND regression" -> AndExpr(SimpleTag("smoke"), SimpleTag("regression"))
    - "smoke OR regression" -> OrExpr(SimpleTag("smoke"), SimpleTag("regression"))
    - "a OR b AND c" -> OrExpr(SimpleTag("a"), AndExpr(SimpleTag("b"), SimpleTag("c")))
    - "(a OR b) AND c" -> AndExpr(OrExpr(SimpleTag("a"), SimpleTag("b")), SimpleTag("c"))
    - "((a AND b) OR c) AND d" -> AndExpr(OrExpr(AndExpr(a, b), c), d)

    Invalid inputs (should throw ParseException):
    - "" (empty string)
    - "AND smoke" (leading operator)
    - "smoke AND" (trailing operator)
    - "smoke AND AND regression" (consecutive operators)
    - "((smoke)" (unbalanced parentheses)
    - "()" (empty parentheses)
  </behavior>
  <implementation>
    1. Create TagExpr.java - sealed interface hierarchy:
       ```java
       public sealed interface TagExpr permits SimpleTag, AndExpr, OrExpr {
           // Visitor pattern support for SQL generation
       }

       public record SimpleTag(String tag) implements TagExpr {}
       public record AndExpr(TagExpr left, TagExpr right) implements TagExpr {}
       public record OrExpr(TagExpr left, TagExpr right) implements TagExpr {}
       ```

    2. Create TagExpressionParser.java:
       ```java
       public class TagExpressionParser {
           private final String input;
           private int pos;

           public TagExpressionParser(String input) {
               this.input = input.trim();
               this.pos = 0;
           }

           public static TagExpr parse(String input) {
               return new TagExpressionParser(input).parseExpr();
           }

           private TagExpr parseExpr() {
               TagExpr left = parseTerm();
               while (matchKeyword("OR")) {
                   TagExpr right = parseTerm();
                   left = new OrExpr(left, right);
               }
               return left;
           }

           private TagExpr parseTerm() {
               TagExpr left = parseFactor();
               while (matchKeyword("AND")) {
                   TagExpr right = parseFactor();
                   left = new AndExpr(left, right);
               }
               return left;
           }

           private TagExpr parseFactor() {
               skipWhitespace();
               if (match('(')) {
                   TagExpr expr = parseExpr();
                   expect(')');
                   return expr;
               }
               return parseTag();
           }

           private SimpleTag parseTag() {
               // Parse identifier (letters, digits, underscore, hyphen)
               // Optionally followed by = and value
               // Stop at whitespace, (, ), or end of input
           }

           // Helper methods: skipWhitespace, match, matchKeyword, expect, peek
       }
       ```

    3. ParseException for invalid input (unchecked):
       ```java
       public class ParseException extends RuntimeException {
           public ParseException(String message, int position) {
               super(message + " at position " + position);
           }
       }
       ```
  </implementation>
</feature>

<verification>
Run tests:
```bash
./gradlew :reportcard-server:test --tests "*.TagExpressionParserTest" --info
```

All tests must pass, covering:
- Simple tags
- AND expressions
- OR expressions
- Precedence (AND > OR)
- Parentheses
- Nested expressions
- Invalid inputs
- Whitespace handling
</verification>

<success_criteria>
1. TagExpr.java exists with sealed interface hierarchy
2. TagExpressionParser.parse() returns correct AST
3. Precedence: AND binds tighter than OR
4. Parentheses override precedence
5. Invalid inputs throw ParseException
6. All unit tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/08-tags-implementation/08-04-SUMMARY.md`
</output>
