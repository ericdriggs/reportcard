---
phase: 08-tags-implementation
plan: 03
type: execute
wave: 2
depends_on: ["08-01", "08-02"]
files_modified:
  - reportcard-server/src/main/resources/db/migration/V1.3__add_test_result_tags.sql
  - reportcard-server/src/generated/java/io/github/ericdriggs/reportcard/gen/db/tables/TestResult.java
autonomous: false

must_haves:
  truths:
    - "test_result table has tags JSON column"
    - "Multi-value index exists on test_result.tags"
    - "JOOQ generated classes include tags column"
  artifacts:
    - path: "reportcard-server/src/main/resources/db/migration/V1.3__add_test_result_tags.sql"
      provides: "DDL for tags column and index"
      contains: "ALTER TABLE test_result ADD COLUMN tags JSON"
    - path: "reportcard-server/src/generated/java/io/github/ericdriggs/reportcard/gen/db/tables/TestResult.java"
      provides: "JOOQ generated class with tags field"
      contains: "TAGS"
  key_links:
    - from: "V1.3__add_test_result_tags.sql"
      to: "test_result table"
      via: "ALTER TABLE DDL"
      pattern: "ALTER TABLE test_result"
---

<objective>
Add tags JSON column to test_result table with multi-value index for efficient MEMBER OF queries.

Purpose: test_result.tags stores flattened union of all feature and scenario tags for indexed querying. The multi-value index enables efficient MEMBER OF searches.

Output: Migration script and regenerated JOOQ classes with tags column support.
</objective>

<execution_context>
@/Users/eric.r.driggs/.claude/get-shit-done/workflows/execute-plan.md
@/Users/eric.r.driggs/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/07-tags-investigation/07-RESEARCH.md
@.planning/phases/07-tags-investigation/07-01-TAG-MAPPING-SPEC.md

# Existing schema
@reportcard-server/src/main/resources/db/migration/V1.0__reportcard_mysql_ddl.sql
@reportcard-server/src/main/resources/db/migration/V1.2__add_test_result_timing.sql
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create migration script for tags column and index</name>
  <files>reportcard-server/src/main/resources/db/migration/V1.3__add_test_result_tags.sql</files>
  <action>
    Create V1.3__add_test_result_tags.sql with:

    ```sql
    -- Add tags JSON column to test_result table for tag-based search
    -- Run manually on deployed databases (project does not use Flyway auto-migration)
    -- ALGORITHM=INPLACE, LOCK=NONE allows concurrent reads/writes during ALTER

    -- Step 1: Add tags column
    ALTER TABLE test_result
      ADD COLUMN tags JSON NULL DEFAULT NULL
      COMMENT 'Flattened array of all feature and scenario tags, deduplicated, for MEMBER OF queries'
      ALGORITHM=INPLACE, LOCK=NONE;

    -- Step 2: Create multi-value index for tag search
    -- Index uses VARCHAR(100) ARRAY - each tag element indexed individually
    -- IMPORTANT: OR queries must use UNION (single WHERE with OR does NOT use index)
    -- IMPORTANT: ALGORITHM=COPY required for multi-value indexes (table rebuild)
    CREATE INDEX idx_test_result_tags ON test_result (
        (CAST(tags->'$[*]' AS VARCHAR(100) ARRAY))
    ) COMMENT 'Multi-value index enables MEMBER OF queries on tag names';
    ```

    Note: Per Phase 7 research, multi-value indexes require ALGORITHM=COPY (table rebuild). The ALGORITHM option is omitted from CREATE INDEX as MySQL will use COPY automatically.
  </action>
  <verify>
    File exists with correct syntax:
    ```bash
    cat reportcard-server/src/main/resources/db/migration/V1.3__add_test_result_tags.sql
    ```
  </verify>
  <done>
    - Migration script created at V1.3 location
    - Contains ALTER TABLE for tags column
    - Contains CREATE INDEX for multi-value index
    - Comments explain usage requirements (UNION for OR queries)
  </done>
</task>

<task type="checkpoint:human-action" gate="blocking">
  <action>Apply migration to local MySQL database</action>
  <instructions>
    The user must manually apply the migration to their local MySQL database.

    JOOQ code generation requires the schema change to exist in the database.

    Steps:
    1. Connect to local MySQL: `mysql -u root -p reportcard`
    2. Run the migration script:
       ```sql
       source reportcard-server/src/main/resources/db/migration/V1.3__add_test_result_tags.sql
       ```
    3. Verify column exists:
       ```sql
       DESCRIBE test_result;
       -- Should show: tags | json | YES | | NULL |
       ```
    4. Verify index exists:
       ```sql
       SHOW INDEX FROM test_result WHERE Key_name = 'idx_test_result_tags';
       ```
  </instructions>
  <resume-signal>Type "migration applied" when local MySQL has the tags column and index</resume-signal>
</task>

<task type="auto">
  <name>Task 3: Regenerate JOOQ classes</name>
  <files>reportcard-server/src/generated/java/io/github/ericdriggs/reportcard/gen/db/tables/TestResult.java</files>
  <action>
    Run JOOQ code generation to pick up the new tags column:

    ```bash
    ./gradlew generateJooqSchemaSource
    ```

    This will regenerate all JOOQ classes from the local MySQL schema.

    After regeneration, verify the TestResult class includes the TAGS field.
  </action>
  <verify>
    Check JOOQ generated class:
    ```bash
    grep -n "TAGS" reportcard-server/src/generated/java/io/github/ericdriggs/reportcard/gen/db/tables/TestResult.java
    ```
    Should show TAGS field definition.
  </verify>
  <done>
    - JOOQ generation completes without error
    - TestResult.java contains TAGS field
    - TestResultRecord.java has getTags()/setTags() methods
  </done>
</task>

</tasks>

<verification>
Build server module to confirm JOOQ integration:
```bash
./gradlew :reportcard-server:compileJava
```

Should compile successfully with new TAGS column available.
</verification>

<success_criteria>
1. V1.3 migration script exists with correct DDL
2. Local MySQL has tags column on test_result
3. Local MySQL has idx_test_result_tags index
4. JOOQ TestResult class has TAGS field
5. Server module compiles successfully
</success_criteria>

<output>
After completion, create `.planning/phases/08-tags-implementation/08-03-SUMMARY.md`
</output>
