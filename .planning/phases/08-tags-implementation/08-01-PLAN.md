---
phase: 08-tags-implementation
plan: 01
type: tdd
wave: 1
depends_on: []
files_modified:
  - reportcard-model/src/main/java/io/github/ericdriggs/reportcard/model/converter/karate/KarateTagExtractor.java
  - reportcard-model/src/test/java/io/github/ericdriggs/reportcard/model/converter/karate/KarateTagExtractorTest.java
autonomous: true

must_haves:
  truths:
    - "Tags extracted from Karate JSON tag arrays"
    - "@ prefix stripped from all tags"
    - "All whitespace removed from tags"
    - "Comma-separated values expanded with prefix propagation"
    - "Invalid comma-without-equals throws exception"
  artifacts:
    - path: "reportcard-model/src/main/java/io/github/ericdriggs/reportcard/model/converter/karate/KarateTagExtractor.java"
      provides: "Tag extraction logic"
      exports: ["extractTags", "expandTag"]
    - path: "reportcard-model/src/test/java/io/github/ericdriggs/reportcard/model/converter/karate/KarateTagExtractorTest.java"
      provides: "Unit tests for tag extraction"
      min_lines: 100
  key_links:
    - from: "KarateTagExtractor.java"
      to: "JsonNode"
      via: "Jackson JsonNode for parsing tag arrays"
      pattern: "JsonNode.*path.*name"
---

<objective>
Implement KarateTagExtractor class with TDD approach to extract and transform tags from Karate JSON.

Purpose: Tags are embedded in Karate JSON at feature and scenario levels. This extractor transforms raw tag objects into normalized strings for storage and querying.

Output: KarateTagExtractor class with extractTags() and expandTag() methods, plus comprehensive unit tests.
</objective>

<execution_context>
@/Users/eric.r.driggs/.claude/get-shit-done/workflows/execute-plan.md
@/Users/eric.r.driggs/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/07-tags-investigation/07-01-TAG-MAPPING-SPEC.md

# Existing Karate converter patterns
@reportcard-model/src/main/java/io/github/ericdriggs/reportcard/model/converter/karate/KarateConvertersUtil.java
@reportcard-model/src/test/java/io/github/ericdriggs/reportcard/model/converter/karate/KarateConvertersUtilTest.java
</context>

<feature>
  <name>KarateTagExtractor</name>
  <files>
    reportcard-model/src/main/java/io/github/ericdriggs/reportcard/model/converter/karate/KarateTagExtractor.java
    reportcard-model/src/test/java/io/github/ericdriggs/reportcard/model/converter/karate/KarateTagExtractorTest.java
  </files>
  <behavior>
    Tag extraction transforms Karate JSON tag arrays into normalized string lists.

    Input format (Karate JSON):
    [{"name": "@smoke", "line": 1}, {"name": "@env=staging", "line": 2}]

    Transformation rules:
    1. Strip @ prefix: "@smoke" -> "smoke"
    2. Remove all whitespace: "@ env = dev" -> "env=dev"
    3. Expand comma-separated values: "@env=dev,test" -> ["env=dev", "env=test"]
    4. Comma without = is invalid: "@smoke,regression" -> IllegalArgumentException

    Test cases (input -> expected output):
    - null/empty array -> []
    - [{"name": "@smoke"}] -> ["smoke"]
    - [{"name": "@env=staging"}] -> ["env=staging"]
    - [{"name": "@ smoke "}] -> ["smoke"]
    - [{"name": "@env=dev,test"}] -> ["env=dev", "env=test"]
    - [{"name": "@env=dev, test"}] -> ["env=dev", "env=test"]
    - [{"name": "@env=dev,test,prod"}] -> ["env=dev", "env=test", "env=prod"]
    - [{"name": "@foo=bar=baz"}] -> ["foo=bar=baz"]
    - [{"name": "@smoke,regression"}] -> throws IllegalArgumentException
    - Multiple tags -> deduplicated set preserving order
  </behavior>
  <implementation>
    Create KarateTagExtractor class following 07-01-TAG-MAPPING-SPEC.md pseudocode:

    - extractTags(JsonNode tagsArray): List<String>
      - Return empty list for null/non-array input
      - Iterate tag objects, extract "name" field
      - Call expandTag() on each name
      - Collect into LinkedHashSet for deduplication
      - Return as ArrayList

    - expandTag(String raw): List<String> (private)
      - Strip @ prefix if present
      - Remove all whitespace with replaceAll("\\s+", "")
      - Split on comma
      - If single part, return as-is
      - If multiple parts:
        - First part must contain = (else throw)
        - Extract prefix (everything up to and including first =)
        - For each part: if contains =, use as-is; else prepend prefix
      - Return expanded list
  </implementation>
</feature>

<verification>
Run tests:
```bash
./gradlew :reportcard-model:test --tests "*.KarateTagExtractorTest" --info
```

All tests must pass, covering:
- Null/empty input handling
- @ prefix stripping
- Whitespace removal
- Comma expansion with prefix propagation
- Invalid comma-without-equals rejection
- Deduplication
</verification>

<success_criteria>
1. KarateTagExtractor class exists in reportcard-model converter/karate package
2. extractTags() accepts JsonNode, returns List<String>
3. expandTag() handles comma expansion per spec
4. All unit tests pass
5. Test coverage includes edge cases from spec
</success_criteria>

<output>
After completion, create `.planning/phases/08-tags-implementation/08-01-SUMMARY.md`
</output>
