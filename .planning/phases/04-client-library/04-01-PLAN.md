---
phase: 04-client-library
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - reportcard-client/build.gradle
  - reportcard-client/src/main/java/io/github/ericdriggs/reportcard/client/ClientArg.java
  - reportcard-client/src/main/java/io/github/ericdriggs/reportcard/client/ReportMetaData.java
  - reportcard-client/src/main/java/io/github/ericdriggs/reportcard/client/PostRequest.java
  - reportcard-client/src/main/java/io/github/ericdriggs/reportcard/client/PostWebClient.java
  - reportcard-client/src/main/java/io/github/ericdriggs/reportcard/client/util/TarGzUtil.java
autonomous: true

must_haves:
  truths:
    - "Client can upload JUnit XML reports as tar.gz to correct server endpoint"
    - "Client can optionally upload Karate JSON reports alongside JUnit XML"
    - "Client creates tar.gz archives from directories before upload"
    - "Upload succeeds when only JUnit provided (backwards compatible)"
    - "Upload succeeds when both JUnit and Karate provided"
  artifacts:
    - path: "reportcard-client/src/main/java/io/github/ericdriggs/reportcard/client/ClientArg.java"
      provides: "KARATE_REPORT_PATH optional parameter"
      contains: "KARATE_REPORT_PATH\\(false\\)"
    - path: "reportcard-client/src/main/java/io/github/ericdriggs/reportcard/client/ReportMetaData.java"
      provides: "karateJsonFile field for optional Karate directory path"
      contains: "karateJsonFile"
    - path: "reportcard-client/src/main/java/io/github/ericdriggs/reportcard/client/util/TarGzUtil.java"
      provides: "Tar.gz creation from directories"
      contains: "createTarGzFromDirectory"
      min_lines: 50
    - path: "reportcard-client/src/main/java/io/github/ericdriggs/reportcard/client/PostWebClient.java"
      provides: "Multipart upload with junit.tar.gz and optional karate.tar.gz"
      contains: "junit\\.tar\\.gz"
    - path: "reportcard-client/src/main/java/io/github/ericdriggs/reportcard/client/PostRequest.java"
      provides: "Correct server endpoint URL"
      contains: "/v1/api/junit/storage/"
  key_links:
    - from: "reportcard-client/src/main/java/io/github/ericdriggs/reportcard/client/ClientArg.java"
      to: "reportcard-client/src/main/java/io/github/ericdriggs/reportcard/client/ReportMetaData.java"
      via: "KARATE_REPORT_PATH mapped to karateJsonFile field"
      pattern: "argMap\\.get\\(ClientArg\\.KARATE_REPORT_PATH\\)"
    - from: "reportcard-client/src/main/java/io/github/ericdriggs/reportcard/client/PostWebClient.java"
      to: "reportcard-client/src/main/java/io/github/ericdriggs/reportcard/client/util/TarGzUtil.java"
      via: "calls createTarGzFromDirectory for both JUnit and Karate"
      pattern: "TarGzUtil\\.createTarGzFromDirectory"
    - from: "reportcard-client/src/main/java/io/github/ericdriggs/reportcard/client/PostWebClient.java"
      to: "reportcard-client/src/main/java/io/github/ericdriggs/reportcard/client/PostRequest.java"
      via: "uses getPostUrl() for endpoint"
      pattern: "scannerPostRequest\\.getPostUrl\\(\\)"
---

<objective>
Update Java client library to support uploading Karate JSON files alongside JUnit XML reports, matching the server's multipart tar.gz upload endpoint.

Purpose: Enable clients to send Karate timing data to server for wall clock execution time tracking
Output: Client can upload both JUnit and optional Karate tar.gz archives to correct endpoint
</objective>

<execution_context>
@/Users/eric.r.driggs/.claude/get-shit-done/workflows/execute-plan.md
@/Users/eric.r.driggs/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@/Users/eric.r.driggs/github/ericdriggs/reportcard/.planning/PROJECT.md
@/Users/eric.r.driggs/github/ericdriggs/reportcard/.planning/ROADMAP.md
@/Users/eric.r.driggs/github/ericdriggs/reportcard/.planning/STATE.md
@/Users/eric.r.driggs/github/ericdriggs/reportcard/.planning/phases/04-client-library/04-RESEARCH.md
@/Users/eric.r.driggs/github/ericdriggs/reportcard/.planning/phases/03-api-integration/03-02-SUMMARY.md

# Client source files
@/Users/eric.r.driggs/github/ericdriggs/reportcard/reportcard-client/src/main/java/io/github/ericdriggs/reportcard/client/ClientArg.java
@/Users/eric.r.driggs/github/ericdriggs/reportcard/reportcard-client/src/main/java/io/github/ericdriggs/reportcard/client/ReportMetaData.java
@/Users/eric.r.driggs/github/ericdriggs/reportcard/reportcard-client/src/main/java/io/github/ericdriggs/reportcard/client/PostRequest.java
@/Users/eric.r.driggs/github/ericdriggs/reportcard/reportcard-client/src/main/java/io/github/ericdriggs/reportcard/client/PostWebClient.java
@/Users/eric.r.driggs/github/ericdriggs/reportcard/reportcard-client/build.gradle

# Server reference for tar.gz patterns
@/Users/eric.r.driggs/github/ericdriggs/reportcard/reportcard-server/src/main/java/io/github/ericdriggs/reportcard/util/tar/TarCompressor.java
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Apache Commons Compress dependency and KARATE_REPORT_PATH parameter</name>
  <files>
    reportcard-client/build.gradle
    reportcard-client/src/main/java/io/github/ericdriggs/reportcard/client/ClientArg.java
    reportcard-client/src/main/java/io/github/ericdriggs/reportcard/client/ReportMetaData.java
  </files>
  <action>
Add Apache Commons Compress 1.26.0 to reportcard-client/build.gradle dependencies section (matches server version for consistent tar.gz format).

Add KARATE_REPORT_PATH optional parameter to ClientArg enum:
```java
/**
 * The path to a single folder containing Karate JSON reports. Will not search sub-folders.
 * (Optional)
 */
KARATE_REPORT_PATH(false),
```

Add karateJsonFile field to ReportMetaData class:
- Add private String karateJsonFile field after testReportRegex
- In constructor, extract karateJsonFile from argMap.get(ClientArg.KARATE_REPORT_PATH)
- No validation required (field is optional)

Pattern: Follow existing TEST_REPORT_PATH parameter structure (optional, directory path)
  </action>
  <verify>
./gradlew reportcard-client:dependencies | grep commons-compress
grep "KARATE_REPORT_PATH" reportcard-client/src/main/java/io/github/ericdriggs/reportcard/client/ClientArg.java
grep "karateJsonFile" reportcard-client/src/main/java/io/github/ericdriggs/reportcard/client/ReportMetaData.java
  </verify>
  <done>
Commons Compress 1.26.0 in client dependencies, KARATE_REPORT_PATH enum value exists with isRequired=false, ReportMetaData has karateJsonFile field extracted from argMap
  </done>
</task>

<task type="auto">
  <name>Task 2: Create TarGzUtil for tar.gz archive creation</name>
  <files>
    reportcard-client/src/main/java/io/github/ericdriggs/reportcard/client/util/TarGzUtil.java
  </files>
  <action>
Create TarGzUtil class in reportcard-client/src/main/java/io/github/ericdriggs/reportcard/client/util/ package.

Implementation pattern from server TarCompressor.java adapted for client:
- Package: io.github.ericdriggs.reportcard.client.util
- Imports: Commons Compress (TarArchiveOutputStream, TarArchiveEntry, GzipCompressorOutputStream), java.nio.file, Lombok @SneakyThrows
- Method: public static Path createTarGzFromDirectory(Path directory, String fileRegex)
  - Validate directory exists using Files.isDirectory()
  - List files using Files.list() (NOT Files.walk - single level only)
  - Filter by fileRegex using Pattern.compile().matcher().matches()
  - Throw IllegalArgumentException if no matching files found
  - Create temp file: Files.createTempFile("reportcard-", ".tar.gz")
  - Stream: OutputStream -> BufferedOutputStream -> GzipCompressorOutputStream -> TarArchiveOutputStream
  - For each file: create TarArchiveEntry with filename only (not full path), copy file content
  - Close streams using try-with-resources
  - Return temp tar.gz Path

Why single-level Files.list(): Matches existing TEST_REPORT_PATH behavior (no subdirectory search), consistent with server expectations.
  </action>
  <verify>
ls reportcard-client/src/main/java/io/github/ericdriggs/reportcard/client/util/TarGzUtil.java
grep "createTarGzFromDirectory" reportcard-client/src/main/java/io/github/ericdriggs/reportcard/client/util/TarGzUtil.java
  </verify>
  <done>
TarGzUtil.java exists with createTarGzFromDirectory method accepting Path directory and String fileRegex, returns Path to temp tar.gz file
  </done>
</task>

<task type="auto">
  <name>Task 3: Update PostWebClient and PostRequest for tar.gz uploads to correct endpoint</name>
  <files>
    reportcard-client/src/main/java/io/github/ericdriggs/reportcard/client/PostRequest.java
    reportcard-client/src/main/java/io/github/ericdriggs/reportcard/client/PostWebClient.java
  </files>
  <action>
Update PostRequest.getPostUrl() to use correct server endpoint:
- Change from: "/v1/api/reports/"
- Change to: "/v1/api/junit/storage/html/tar.gz"
- Reason: Current endpoint doesn't exist on server; server expects /v1/api/junit/storage/{label}/tar.gz

Update PostWebClient.postTestReport() to create tar.gz archives and upload:
1. Add import: io.github.ericdriggs.reportcard.client.util.TarGzUtil
2. Replace individual file upload logic with tar.gz creation:
   - Remove existing File[] files array and loop
   - Create junitTarGz using TarGzUtil.createTarGzFromDirectory(Path.of(testReportPath), testReportRegex)
   - If karateJsonFile is not empty, create karateTarGz using TarGzUtil.createTarGzFromDirectory(Path.of(karateJsonFile), ".*\\.json$")
   - Store both paths for cleanup

3. Update multipart body:
   - Keep existing reportMetaData part unchanged
   - Replace files loop with: multipartBodyBuilder.part("junit.tar.gz", new FileSystemResource(junitTarGz.toFile()), MediaType.APPLICATION_OCTET_STREAM)
   - Add conditional: if (karateTarGz != null) { multipartBodyBuilder.part("karate.tar.gz", new FileSystemResource(karateTarGz.toFile()), MediaType.APPLICATION_OCTET_STREAM) }

4. Add cleanup in finally block:
   - After WebClient request completes (success or failure), delete temp files
   - Method: Files.deleteIfExists() for both junitTarGz and karateTarGz (null-safe)
   - Log warnings on cleanup failures (don't throw - cleanup is best-effort)

Pattern: Wrap request in try-finally for guaranteed temp file cleanup, preventing disk space leaks.

Why "html" label: Matches server endpoint path variable; this is the storage type identifier for HTML reports.
  </action>
  <verify>
grep "/v1/api/junit/storage/html/tar.gz" reportcard-client/src/main/java/io/github/ericdriggs/reportcard/client/PostRequest.java
grep "TarGzUtil.createTarGzFromDirectory" reportcard-client/src/main/java/io/github/ericdriggs/reportcard/client/PostWebClient.java
grep "junit.tar.gz" reportcard-client/src/main/java/io/github/ericdriggs/reportcard/client/PostWebClient.java
grep "karate.tar.gz" reportcard-client/src/main/java/io/github/ericdriggs/reportcard/client/PostWebClient.java
  </verify>
  <done>
PostRequest returns correct endpoint URL, PostWebClient creates tar.gz archives for both JUnit and optional Karate, uploads both as multipart, cleans up temp files in finally block
  </done>
</task>

</tasks>

<verification>
Build client module:
```bash
./gradlew reportcard-client:build
```

Verify changes compile and tests pass (if client has tests).

Manual inspection:
- ClientArg.KARATE_REPORT_PATH exists with isRequired=false
- ReportMetaData.karateJsonFile field extracted from ClientArg
- TarGzUtil.createTarGzFromDirectory creates valid tar.gz from directory with regex filter
- PostWebClient creates tar.gz for JUnit, optionally for Karate
- PostWebClient uploads junit.tar.gz (required) and karate.tar.gz (optional) as multipart
- PostRequest.getPostUrl() returns /v1/api/junit/storage/html/tar.gz
- Temp files deleted in finally block after upload
</verification>

<success_criteria>
1. Commons Compress 1.26.0 in client dependencies
2. KARATE_REPORT_PATH parameter available as ClientArg
3. TarGzUtil creates tar.gz archives from directories with regex filtering
4. PostWebClient uploads junit.tar.gz to correct endpoint
5. PostWebClient optionally includes karate.tar.gz when KARATE_REPORT_PATH provided
6. Client backwards compatible: JUnit-only uploads work without Karate parameter
7. Temp tar.gz files cleaned up after upload completes
8. Build succeeds: ./gradlew reportcard-client:build passes
</success_criteria>

<output>
After completion, create `.planning/phases/04-client-library/04-01-SUMMARY.md`
</output>
