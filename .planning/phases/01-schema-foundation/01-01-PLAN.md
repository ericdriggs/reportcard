---
phase: 01-schema-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - reportcard-server/src/main/resources/db/migration/V1.0__reportcard_mysql_ddl.sql
  - reportcard-server/src/main/resources/db/migration/V1.1__reportcard_mysql_dml.sql
  - reportcard-server/src/main/java/io/github/ericdriggs/reportcard/persist/StorageType.java
  - reportcard-server/src/generated/java/io/github/ericdriggs/reportcard/gen/db/tables/RunTable.java
  - reportcard-server/src/generated/java/io/github/ericdriggs/reportcard/gen/db/tables/records/RunRecord.java
autonomous: true

must_haves:
  truths:
    - "run table has start_time column (DATETIME, NULLable)"
    - "run table has end_time column (DATETIME, NULLable)"
    - "storage_type table contains KARATE entry with ID 9"
    - "StorageType Java enum includes KARATE(9)"
    - "JOOQ generated RunRecord has getStartTime() and setStartTime() methods"
    - "JOOQ generated RunRecord has getEndTime() and setEndTime() methods"
  artifacts:
    - path: "reportcard-server/src/main/resources/db/migration/V1.0__reportcard_mysql_ddl.sql"
      provides: "run table DDL with start_time and end_time columns"
      contains: "`start_time` DATETIME NULL"
    - path: "reportcard-server/src/main/resources/db/migration/V1.1__reportcard_mysql_dml.sql"
      provides: "KARATE storage type reference data"
      contains: "(9, 'KARATE')"
    - path: "reportcard-server/src/main/java/io/github/ericdriggs/reportcard/persist/StorageType.java"
      provides: "KARATE enum constant"
      contains: "KARATE(9)"
    - path: "reportcard-server/src/generated/java/io/github/ericdriggs/reportcard/gen/db/tables/records/RunRecord.java"
      provides: "JOOQ RunRecord with timing accessors"
      contains: "getStartTime"
  key_links:
    - from: "V1.1__reportcard_mysql_dml.sql"
      to: "StorageType.java"
      via: "enum ID matches database ID"
      pattern: "KARATE\\(9\\)"
    - from: "V1.0__reportcard_mysql_ddl.sql"
      to: "RunRecord.java (generated)"
      via: "JOOQ code generation"
      pattern: "getStartTime|setStartTime"
---

<objective>
Add database schema support for run-level timing (start_time, end_time) and KARATE storage type, with synchronized JOOQ code generation.

Purpose: Enable capturing wall clock execution time from Karate JSON files. This is foundational for all subsequent phases.

Output: Modified DDL/DML files, updated StorageType enum, regenerated JOOQ classes with new columns and storage type.
</objective>

<execution_context>
@/Users/eric.r.driggs/.claude/get-shit-done/workflows/execute-plan.md
@/Users/eric.r.driggs/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@/Users/eric.r.driggs/github/ericdriggs/reportcard/.planning/PROJECT.md
@/Users/eric.r.driggs/github/ericdriggs/reportcard/.planning/ROADMAP.md
@/Users/eric.r.driggs/github/ericdriggs/reportcard/.planning/STATE.md
@/Users/eric.r.driggs/github/ericdriggs/reportcard/.planning/phases/01-schema-foundation/01-RESEARCH.md

# Key source files
@/Users/eric.r.driggs/github/ericdriggs/reportcard/reportcard-server/src/main/resources/db/migration/V1.0__reportcard_mysql_ddl.sql
@/Users/eric.r.driggs/github/ericdriggs/reportcard/reportcard-server/src/main/resources/db/migration/V1.1__reportcard_mysql_dml.sql
@/Users/eric.r.driggs/github/ericdriggs/reportcard/reportcard-server/src/main/java/io/github/ericdriggs/reportcard/persist/StorageType.java
@/Users/eric.r.driggs/github/ericdriggs/reportcard/CLAUDE.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add timing columns to run table DDL</name>
  <files>reportcard-server/src/main/resources/db/migration/V1.0__reportcard_mysql_ddl.sql</files>
  <action>
Edit the CREATE TABLE statement for `reportcard`.`run` table (around line 128-148).

Add two new columns AFTER the `is_success` column and BEFORE the PRIMARY KEY:
```sql
  `start_time` DATETIME NULL,
  `end_time` DATETIME NULL,
```

**Critical constraints:**
- Columns must be DATETIME type (not TIMESTAMP) - project standard for timezone-neutral storage
- Columns must be NULL (not NOT NULL) - backwards compatibility with existing rows
- Place columns after `is_success` and before PRIMARY KEY declaration
- Match existing code style: backticks, 2-space indent, comma at end of line

**Why NULL:** Existing run records in production won't have timing data. NULLable columns allow schema change without data migration. JOOQ will map DATETIME to Java Instant via existing ForcedType configuration.

**What NOT to do:**
- Do NOT create separate ALTER TABLE script - project pattern is to edit CREATE TABLE directly
- Do NOT use TIMESTAMP type - project uses DATETIME consistently
- Do NOT make columns NOT NULL - breaks backwards compatibility
  </action>
  <verify>grep -A 10 "is_success" reportcard-server/src/main/resources/db/migration/V1.0__reportcard_mysql_ddl.sql | grep -c "start_time\|end_time"</verify>
  <done>DDL file contains start_time and end_time columns in run table CREATE statement, both DATETIME NULL, positioned after is_success</done>
</task>

<task type="auto">
  <name>Task 2: Add KARATE storage type and update enum</name>
  <files>reportcard-server/src/main/resources/db/migration/V1.1__reportcard_mysql_dml.sql, reportcard-server/src/main/java/io/github/ericdriggs/reportcard/persist/StorageType.java</files>
  <action>
**Part A - Update DML file:**
Edit `V1.1__reportcard_mysql_dml.sql` (around line 15-24).

Add KARATE to the storage_type INSERT statement, using ID 9:
```sql
INSERT `reportcard`.`storage_type`
(`storage_type_id`, `storage_type_name`)
VALUES (1, 'HTML'),
       (2, 'JSON'),
       (3, 'LOG'),
       (4, 'OTHER'),
       (5, 'TAR_GZ'),
       (6, 'XML'),
       (7, 'ZIP'),
       (8, 'JUNIT'),
       (9, 'KARATE');
```

**Part B - Update Java enum:**
Edit `StorageType.java` (around line 8-18).

Add KARATE enum constant BEFORE the closing semicolon:
```java
public enum StorageType {

    HTML(1),
    JSON(2),
    LOG(3),
    OTHER(4),
    TAR_GZ(5),
    XML(6),
    ZIP(7),
    JUNIT(8),
    KARATE(9),
    ;
```

**Critical constraint:** ID 9 must be used in BOTH files. The enum's integer argument MUST match the database storage_type_id exactly. Mismatched IDs cause runtime lookup failures via `fromStorageTypeId()`.

**Why ID 9:** Sequential numbering maintains the established pattern. Never reuse deleted IDs.
  </action>
  <verify>grep -c "KARATE" reportcard-server/src/main/resources/db/migration/V1.1__reportcard_mysql_dml.sql && grep -c "KARATE(9)" reportcard-server/src/main/java/io/github/ericdriggs/reportcard/persist/StorageType.java</verify>
  <done>DML file contains (9, 'KARATE') in storage_type INSERT, Java enum contains KARATE(9), IDs match exactly</done>
</task>

<task type="auto">
  <name>Task 3: Regenerate JOOQ code</name>
  <files>reportcard-server/src/generated/java/io/github/ericdriggs/reportcard/gen/db/</files>
  <action>
Run the JOOQ code generation Gradle task to regenerate type-safe Java classes from the modified schema:

```bash
cd /Users/eric.r.driggs/github/ericdriggs/reportcard
./gradlew generateJooqSchemaSource
```

This task connects to local MySQL (localhost:3306/reportcard), reads schema metadata, and generates Java classes.

**Prerequisites (must already exist):**
- Local MySQL 8.0 running on localhost:3306
- `reportcard` database exists
- DDL/DML files already applied to local MySQL
- Database credentials match build.gradle jooq configuration

**What this generates:**
- RunTable.java with START_TIME and END_TIME field constants
- RunRecord.java with getStartTime(), setStartTime(), getEndTime(), setEndTime() methods
- StorageTypeRecord.java (if schema changed)
- Type mapping: DATETIME â†’ Java Instant (via existing ForcedType config)

**If this fails:**
- MySQL not running: Start MySQL service
- Database doesn't exist: Create database and apply DDL/DML manually
- Connection error: Check credentials in build.gradle jooq.edition.forceTypes block
- Schema out of sync: Manually run `mysql -u root -p reportcard < V1.0__reportcard_mysql_ddl.sql` then `< V1.1__reportcard_mysql_dml.sql`

**Why this is critical:** Business logic compiles against generated code. Skipping this causes "method not found" compile errors or runtime SQL exceptions.
  </action>
  <verify>ls reportcard-server/src/generated/java/io/github/ericdriggs/reportcard/gen/db/tables/records/RunRecord.java && grep -c "getStartTime\|setStartTime\|getEndTime\|setEndTime" reportcard-server/src/generated/java/io/github/ericdriggs/reportcard/gen/db/tables/records/RunRecord.java</verify>
  <done>JOOQ generated RunRecord.java contains getStartTime(), setStartTime(), getEndTime(), setEndTime() methods; methods return/accept Java Instant type</done>
</task>

</tasks>

<verification>
**Schema verification:**
```bash
# Verify DDL contains new columns
grep "start_time\|end_time" reportcard-server/src/main/resources/db/migration/V1.0__reportcard_mysql_ddl.sql

# Verify DML contains KARATE
grep "KARATE" reportcard-server/src/main/resources/db/migration/V1.1__reportcard_mysql_dml.sql

# Verify enum contains KARATE(9)
grep "KARATE(9)" reportcard-server/src/main/java/io/github/ericdriggs/reportcard/persist/StorageType.java

# Verify JOOQ generated timing accessors
grep "getStartTime\|setStartTime\|getEndTime\|setEndTime" reportcard-server/src/generated/java/io/github/ericdriggs/reportcard/gen/db/tables/records/RunRecord.java
```

**Synchronization verification:**
- [ ] Database ID in DML (9) matches Java enum ID (9)
- [ ] DATETIME columns in DDL are NULL
- [ ] JOOQ methods use Java Instant type (not String or Date)

**Build verification:**
```bash
./gradlew clean build
```

If build succeeds, schema changes are valid and JOOQ code is synchronized.
</verification>

<success_criteria>
1. V1.0__reportcard_mysql_ddl.sql contains `start_time DATETIME NULL` and `end_time DATETIME NULL` in run table
2. V1.1__reportcard_mysql_dml.sql contains `(9, 'KARATE')` in storage_type INSERT
3. StorageType.java contains `KARATE(9)` enum constant
4. RunRecord.java (generated) contains getStartTime(), setStartTime(), getEndTime(), setEndTime() methods
5. RunRecord timing methods use Java Instant type
6. Project builds without errors: `./gradlew clean build` succeeds
7. Testcontainers tests pass (they automatically pick up schema changes via docker-entrypoint-initdb.d)
</success_criteria>

<output>
After completion, create `.planning/phases/01-schema-foundation/01-01-SUMMARY.md` using the summary template.

Include:
- Files modified (DDL, DML, enum, generated code)
- Schema changes (columns added, storage type added)
- JOOQ regeneration details
- Build verification results
</output>
