---
phase: 10-tag-query-html-interface
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - reportcard-server/src/main/java/io/github/ericdriggs/reportcard/controller/html/TagQueryHtmlHelper.java
  - reportcard-server/src/main/java/io/github/ericdriggs/reportcard/controller/TagQueryUIController.java
  - reportcard-server/src/main/java/io/github/ericdriggs/reportcard/controller/browse/BrowseHtmlHelper.java
  - reportcard-server/src/test/java/io/github/ericdriggs/reportcard/controller/TagQueryUIControllerTest.java
autonomous: true

must_haves:
  truths:
    - "User can search for tests by tag expression from HTML interface"
    - "User sees search form when accessing tag search without query"
    - "User sees grouped results for valid tag expressions"
    - "User sees error message with form for invalid expressions"
    - "User can navigate to tag search from browse pages"
    - "User can navigate from tag results to browse pages"
  artifacts:
    - path: "reportcard-server/src/main/java/io/github/ericdriggs/reportcard/controller/html/TagQueryHtmlHelper.java"
      provides: "HTML generation for tag search forms and results"
      min_lines: 150
    - path: "reportcard-server/src/main/java/io/github/ericdriggs/reportcard/controller/TagQueryUIController.java"
      provides: "HTML endpoints for tag queries"
      exports: ["searchByTagsCompany", "searchByTagsOrg", "searchByTagsRepo", "searchByTagsBranch", "searchByTagsSha"]
    - path: "reportcard-server/src/test/java/io/github/ericdriggs/reportcard/controller/TagQueryUIControllerTest.java"
      provides: "Unit tests for HTML controller"
      min_lines: 100
  key_links:
    - from: "TagQueryUIController"
      to: "TagQueryService"
      via: "dependency injection"
      pattern: "tagQueryService\\.findByTagExpressionByPath"
    - from: "TagQueryHtmlHelper"
      to: "BrowseHtmlHelper"
      via: "class extension"
      pattern: "extends BrowseHtmlHelper"
    - from: "BrowseHtmlHelper.getCompanyLinks"
      to: "/tags/tests"
      via: "navigation link"
      pattern: "Tag Search.*tags/tests"
---

<objective>
Create HTML interface for tag-based test queries with search form, hierarchical results rendering, and navigation integration with browse pages.

Purpose: Make the tag query API discoverable and usable through the web interface
Output: HTML pages for tag search at all hierarchy levels with bidirectional navigation
</objective>

<execution_context>
@/Users/eric.r.driggs/.claude/get-shit-done/workflows/execute-plan.md
@/Users/eric.r.driggs/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-tag-query-html-interface/10-RESEARCH.md
@.planning/phases/09-tag-query-api/09-03-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create TagQueryHtmlHelper with form and results rendering</name>
  <files>reportcard-server/src/main/java/io/github/ericdriggs/reportcard/controller/html/TagQueryHtmlHelper.java</files>
  <action>
    Create TagQueryHtmlHelper.java extending BrowseHtmlHelper with the following methods:

    1. renderTagQueryPage(TagQueryResponse response, CompanyOrgRepoBranchJobRunStageDTO scopePath)
       - Main entry point that delegates to form or results based on response being null

    2. getSearchForm(CompanyOrgRepoBranchJobRunStageDTO scopePath)
       - HTML form with tag expression input field (400px width)
       - Placeholder text: "smoke AND env=prod"
       - Submit button labeled "Search"
       - Syntax help text below form
       - Use method='get' for shareable URLs

    3. getResultsHtml(TagQueryResponse response, CompanyOrgRepoBranchJobRunStageDTO scopePath)
       - Echo query info (scope and tag expression) at top
       - Use StringEscapeUtils.escapeHtml4() for user input (tag expression)
       - Render nested fieldsets: branch -> sha -> job
       - Branch legend includes clickable link to browse page using getUrl()
       - SHA rendered as label only (no SHA-level browse pages exist)
       - Job info shows jobInfo string, run date, and test list
       - Each test name must be HTML-escaped

    4. renderErrorPage(String errorMessage, String originalQuery, CompanyOrgRepoBranchJobRunStageDTO scopePath)
       - Display error message in red
       - Re-render form with original query pre-populated in value attribute
       - HTML-escape both error message and original query

    Use BrowseHtmlHelper utility methods:
    - getPage(main, breadCrumbs) for page structure
    - getUrl(path) for browse page URLs
    - getBreadCrumb(path) for navigation breadcrumbs
    - getLink(text, url) for consistent link formatting

    Follow OrgDashboardHtmlHelper pattern for nested fieldsets with CSS classes:
    - branch-fieldset, sha-fieldset for hierarchy levels
    - Use StringBuilder for dynamic content assembly
    - Include <!--end-X-fieldset--> comments for debugging
  </action>
  <verify>Compile with: ./gradlew :reportcard-server:compileJava</verify>
  <done>TagQueryHtmlHelper class exists with all rendering methods</done>
</task>

<task type="auto">
  <name>Task 2: Create TagQueryUIController with HTML endpoints</name>
  <files>reportcard-server/src/main/java/io/github/ericdriggs/reportcard/controller/TagQueryUIController.java</files>
  <action>
    Create TagQueryUIController.java with:

    1. Class annotations:
       - @RestController
       - @RequestMapping("") - no /api/v1 prefix for HTML endpoints

    2. Dependency injection:
       - @Autowired constructor accepting TagQueryService

    3. Imports needed:
       - Import io.github.ericdriggs.reportcard.model.TagQueryResponse
       - Import io.github.ericdriggs.reportcard.model.TagQueryResponse.QueryInfo (nested class)
       - Import org.apache.lucene.queryparser.flexible.core.QueryNodeException.ParseException

    4. Five endpoints matching TagQueryController paths (without /api/v1):
       - /company/{company}/tags/tests
       - /company/{company}/org/{org}/tags/tests
       - /company/{company}/org/{org}/repo/{repo}/tags/tests
       - /company/{company}/org/{org}/repo/{repo}/branch/{branch}/tags/tests
       - /company/{company}/org/{org}/repo/{repo}/branch/{branch}/sha/{sha}/tags/tests

    5. Each method implementation:
       - @GetMapping with produces = "text/html;charset=UTF-8"
       - @PathVariable for hierarchy components
       - @RequestParam(required = false) String tags
       - Build CompanyOrgRepoBranchJobRunStageDTO from path variables
       - If tags is null or blank: return search form via TagQueryHtmlHelper.renderTagQueryPage(null, scopePath)
       - If tags present, wrap service call in explicit try-catch block:
         ```java
         try {
             Map<String, Map<String, Map<String, List<String>>>> results =
                 tagQueryService.findByTagExpressionByPath(scopePath, tags);
             TagQueryResponse.QueryInfo queryInfo = new TagQueryResponse.QueryInfo(
                 scopePath.toUrlPath(), tags);
             TagQueryResponse response = new TagQueryResponse(queryInfo, results);
             String html = TagQueryHtmlHelper.renderTagQueryPage(response, scopePath);
             return ResponseEntity.ok(html);
         } catch (ParseException e) {
             String errorHtml = TagQueryHtmlHelper.renderErrorPage(
                 e.getMessage(), tags, scopePath);
             return ResponseEntity.badRequest().body(errorHtml);
         }
         ```
       - Return ResponseEntity<String> with appropriate HttpStatus (OK or BAD_REQUEST)

    Follow BrowseUIController pattern for consistency and TagQueryController pattern for building response.
  </action>
  <verify>Compile with: ./gradlew :reportcard-server:compileJava</verify>
  <done>TagQueryUIController exists with 5 HTML endpoints handling form/results/errors</done>
</task>

<task type="auto">
  <name>Task 3: Add Tag Search links to browse navigation</name>
  <files>reportcard-server/src/main/java/io/github/ericdriggs/reportcard/controller/browse/BrowseHtmlHelper.java</files>
  <action>
    Modify BrowseHtmlHelper.java to add Tag Search links:

    1. In getCompanyLinks() method (around line 58):
       - Add new line after {metricsLink}
       - Add placeholder: {tagSearchLink}
       - Add replace: .replace("{tagSearchLink}", getLink("Tag Search üîç", "/company/" + company + "/tags/tests"))
       - Include <br> between links for proper spacing

    2. In getOrgLinks() method (around line 117):
       - Add new line after {metricsLink}
       - Add placeholder: {tagSearchLink}
       - Add replace: .replace("{tagSearchLink}", getLink("Tag Search üîç", orgPath.toUrlPath() + "/tags/tests"))
       - Include <br> between links for proper spacing

    Use emoji üîç for visual consistency with existing Metrics link (üî¢).

    These changes enable bidirectional navigation:
    - Browse pages link to tag search at appropriate scope
    - Tag search results link back to browse pages
  </action>
  <verify>Compile with: ./gradlew :reportcard-server:compileJava</verify>
  <done>Browse pages include Tag Search links in company and org navigation fieldsets</done>
</task>

<task type="auto">
  <name>Task 4: Create unit tests for TagQueryUIController</name>
  <files>reportcard-server/src/test/java/io/github/ericdriggs/reportcard/controller/TagQueryUIControllerTest.java</files>
  <action>
    Create TagQueryUIControllerTest.java with WebMvcTest pattern:

    1. Class setup:
       - @WebMvcTest(TagQueryUIController.class)
       - @AutoConfigureMockMvc
       - @MockBean TagQueryService
       - @Autowired MockMvc

    2. Test scenarios:
       - testSearchFormDisplayed() - GET without tags param returns 200 with form HTML
       - testValidExpressionReturnsResults() - Mock service to return data, verify HTML contains branch/sha/job structure
       - testInvalidExpressionReturnsError() - Mock service to throw ParseException, verify 400 with error message
       - testEmptyTagsShowsForm() - GET with empty tags="" returns form
       - testAllHierarchyLevels() - Verify all 5 endpoints respond (company through sha)

    3. Assertions:
       - Use .andExpect(status().isOk()) or .andExpect(status().isBadRequest())
       - Use .andExpect(content().contentType("text/html;charset=UTF-8"))
       - Use .andExpect(content().string(containsString("expected HTML fragment")))
       - Verify form elements: <input id='tags', <button type='submit'
       - Verify result structure: branch-fieldset, sha-fieldset class names
       - Verify error display: class='error' or similar

    4. Mock data:
       - Create sample TagQueryResponse with nested Map structure
       - Use realistic test names and branch/sha values
       - Include at least 2 branches with multiple tests each

    Follow TagQueryControllerTest (JSON version) patterns but adapt for HTML assertions.
  </action>
  <verify>Run tests: ./gradlew :reportcard-server:test --tests TagQueryUIControllerTest -Si</verify>
  <done>Unit tests pass verifying form display, results rendering, and error handling</done>
</task>

</tasks>

<verification>
1. Start server: ./gradlew :reportcard-server:bootRun
2. Navigate to http://localhost:8080/company/testco/tags/tests
3. Verify search form displays
4. Enter valid expression like "smoke"
5. Verify results display with hierarchy
6. Enter invalid expression like "AND AND"
7. Verify error message with form
8. Check browse pages have Tag Search links
</verification>

<success_criteria>
- TagQueryUIController serves HTML at all 5 hierarchy endpoints
- Empty tags parameter shows search form with input field and submit button
- Valid expressions show hierarchical results (branch/sha/job/tests)
- Invalid expressions show error message with pre-populated form
- Browse pages at company and org levels include Tag Search navigation links
- All unit tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/10-tag-query-html-interface/10-01-SUMMARY.md`
</output>