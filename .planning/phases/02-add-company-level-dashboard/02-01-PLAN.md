---
phase: 02-add-company-level-dashboard
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - reportcard-server/src/main/java/io/github/ericdriggs/reportcard/persist/GraphService.java
  - reportcard-server/src/main/java/io/github/ericdriggs/reportcard/controller/graph/PipelineDashboardHtmlHelper.java
autonomous: true

must_haves:
  truths:
    - Service layer can handle queries with null org parameter without crashing
    - Service returns data aggregated across all orgs when org is null
    - HTML title renders company name only when org is null
  artifacts:
    - path: reportcard-server/src/main/java/io/github/ericdriggs/reportcard/persist/GraphService.java
      provides: Optional org filtering using trueCondition() pattern
      contains: "request.getOrg() != null"
      min_lines: 650
    - path: reportcard-server/src/main/java/io/github/ericdriggs/reportcard/controller/graph/PipelineDashboardHtmlHelper.java
      provides: Conditional title logic
      contains: "request.getOrg() != null"
      min_lines: 175
  key_links:
    - from: PipelineDashboardHtmlHelper.renderPipelineDashboardMetrics
      to: request.getOrg()
      via: null check for title
      pattern: "request\\.getOrg\\(\\) != null"
    - from: GraphService.getPipelineDashboardCompanyGraphs
      to: ORG.ORG_NAME.eq
      via: conditional filter application
      pattern: "if \\(request\\.getOrg\\(\\) != null\\)"
---

<objective>
Backend support for company-level dashboard queries by making org parameter optional in service layer and HTML rendering.

Purpose: Enable GraphService to handle company-level queries (null org) and ensure HTML titles render correctly for both org-level and company-level views.

Output: Service layer that conditionally applies org filter, HTML helper that renders appropriate titles based on whether org is present.
</objective>

<execution_context>
@/Users/eric.r.driggs/.claude/get-shit-done/workflows/execute-plan.md
@/Users/eric.r.driggs/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@/Users/eric.r.driggs/github/ericdriggs/reportcard-company-job-dashboard/.planning/PROJECT.md
@/Users/eric.r.driggs/github/ericdriggs/reportcard-company-job-dashboard/.planning/ROADMAP.md
@/Users/eric.r.driggs/github/ericdriggs/reportcard-company-job-dashboard/.planning/STATE.md
@/Users/eric.r.driggs/github/ericdriggs/reportcard-company-job-dashboard/.planning/phases/02-add-company-level-dashboard/02-RESEARCH.md
@/Users/eric.r.driggs/github/ericdriggs/reportcard-company-job-dashboard/.planning/phases/01-rename-org-level-dashboard/01-01-SUMMARY.md
@/Users/eric.r.driggs/github/ericdriggs/reportcard-company-job-dashboard/CLAUDE.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Make org filter conditional in GraphService</name>
  <files>reportcard-server/src/main/java/io/github/ericdriggs/reportcard/persist/GraphService.java</files>
  <action>
Modify `getPipelineDashboardCompanyGraphs()` method (starts at line 593) to make org filtering conditional:

1. **Update orgCondition assignment (line 600):**
   - Change from: `Condition orgCondition = ORG.ORG_NAME.eq(request.getOrg());`
   - Change to: `Condition orgCondition = request.getOrg() != null ? ORG.ORG_NAME.eq(request.getOrg()) : trueCondition();`

2. **Update tableConditionMap.put for ORG (line 596):**
   - Change from: `tableConditionMap.put(ORG, ORG.ORG_NAME.eq(request.getOrg()));`
   - Change to:
     ```java
     if (request.getOrg() != null) {
         tableConditionMap.put(ORG, ORG.ORG_NAME.eq(request.getOrg()));
     }
     ```

**Why these changes:**
- `trueCondition()` is the JOOQ pattern for "always true" no-op filters (established pattern per 02-RESEARCH.md line 601)
- Conditional tableConditionMap.put prevents null org from breaking the query builder
- JobDashboardRequest.org field is already optional (no @NonNull annotation per 02-RESEARCH.md line 321)
- When org is null, query aggregates across all orgs for the company (natural FK relationship per 02-RESEARCH.md line 349)

**What to avoid:**
- Do NOT modify the runIds query joins (lines 622-628) - all joins are still needed for hierarchy traversal
- Do NOT remove the orgCondition variable - it's still used in line 629 where clause
- Do NOT add new methods - modify existing method to handle both org-level and company-level
  </action>
  <verify>
Run: `./gradlew build`

Verify no compilation errors. Check GraphService.java around lines 593-644 contains:
- `request.getOrg() != null ? ORG.ORG_NAME.eq(request.getOrg()) : trueCondition()`
- `if (request.getOrg() != null)` guard around tableConditionMap.put(ORG, ...)
  </verify>
  <done>
- GraphService compiles without errors
- orgCondition uses ternary with trueCondition() for null org
- tableConditionMap.put(ORG, ...) is conditional on org != null
- No new methods created (modified existing getPipelineDashboardCompanyGraphs)
  </done>
</task>

<task type="auto">
  <name>Task 2: Update HTML title logic for null org</name>
  <files>reportcard-server/src/main/java/io/github/ericdriggs/reportcard/controller/graph/PipelineDashboardHtmlHelper.java</files>
  <action>
Modify `renderPipelineDashboardMetrics()` method (line 174) to handle null org in title:

**Update title assignment (line 175):**
- Change from: `String title = request.getCompany() + "/" + request.getOrg();`
- Change to:
  ```java
  String title = request.getOrg() != null ?
      request.getCompany() + "/" + request.getOrg() :
      request.getCompany();
  ```

**Why this change:**
- Prevents title showing "company/null" on company-level pages (pitfall per 02-RESEARCH.md line 203)
- Org-level pages show "company/org" (existing behavior preserved)
- Company-level pages show "company" only (new behavior)
- HTML table already has org column (line 121 per 02-RESEARCH.md) for grouping, so title doesn't need to repeat org

**What to avoid:**
- Do NOT modify renderPipelineDashboard() method (line 177 calls it) - title is passed as parameter
- Do NOT change method signature - request parameter is sufficient for conditional logic
  </action>
  <verify>
Run: `./gradlew build`

Verify no compilation errors. Check PipelineDashboardHtmlHelper.java line 175 contains ternary operator checking `request.getOrg() != null`.
  </verify>
  <done>
- PipelineDashboardHtmlHelper compiles without errors
- Title uses ternary to conditionally include org
- When org is null, title is just company name
- When org is present, title is "company/org" (preserves existing behavior)
  </done>
</task>

</tasks>

<verification>
After task completion:

1. **Build succeeds:** `./gradlew build` completes without errors
2. **Service layer ready:** GraphService.getPipelineDashboardCompanyGraphs() can accept JobDashboardRequest with null org
3. **HTML rendering ready:** PipelineDashboardHtmlHelper.renderPipelineDashboardMetrics() handles null org in title
4. **No behavioral changes yet:** Existing org-level endpoint at `/company/{company}/org/{org}/jobs` still works identically (org is always present for that endpoint)
</verification>

<success_criteria>
- GraphService compiles and handles null org via trueCondition() pattern
- PipelineDashboardHtmlHelper compiles and renders appropriate titles for both org-level and company-level
- Build passes with no compilation errors or test failures
- Existing org-level endpoint functionality unchanged (regression-free)
- Ready for Plan 02 to add company-level controller endpoint
</success_criteria>

<output>
After completion, create `.planning/phases/02-add-company-level-dashboard/02-01-SUMMARY.md`
</output>
