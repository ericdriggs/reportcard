---
phase: 02-latest-endpoints
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - reportcard-server/src/main/java/io/github/ericdriggs/reportcard/persist/BrowseService.java
  - reportcard-server/src/test/java/io/github/ericdriggs/reportcard/persist/browse/BrowseServiceTest.java
autonomous: true

must_haves:
  truths:
    - "getLatestRunId returns the highest run_id for a given jobId"
    - "getLatestRunId throws 404 when job has no runs"
  artifacts:
    - path: "reportcard-server/src/main/java/io/github/ericdriggs/reportcard/persist/BrowseService.java"
      provides: "getLatestRunId(Long jobId) method"
      contains: "max(RUN.RUN_ID)"
    - path: "reportcard-server/src/test/java/io/github/ericdriggs/reportcard/persist/browse/BrowseServiceTest.java"
      provides: "Unit tests for getLatestRunId"
      contains: "getLatestRunIdSuccessTest"
  key_links:
    - from: "BrowseService.getLatestRunId"
      to: "RUN table"
      via: "JOOQ max(RUN.RUN_ID) query"
      pattern: "max\\(RUN\\.RUN_ID\\)"
---

<objective>
Add getLatestRunId service method to BrowseService

Purpose: Enable resolution of "latest" run for a job, which is the foundation for latest endpoints.
Output: BrowseService.getLatestRunId(Long jobId) method with unit test coverage.
</objective>

<execution_context>
@/Users/eric.r.driggs/.claude/get-shit-done/workflows/execute-plan.md
@/Users/eric.r.driggs/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-latest-endpoints/02-CONTEXT.md
@.planning/phases/02-latest-endpoints/02-RESEARCH.md

# Source files
@reportcard-server/src/main/java/io/github/ericdriggs/reportcard/persist/BrowseService.java
@reportcard-server/src/test/java/io/github/ericdriggs/reportcard/persist/browse/BrowseServiceTest.java
@reportcard-server/src/test/java/io/github/ericdriggs/reportcard/gen/db/TestData.java
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add getLatestRunId method to BrowseService</name>
  <files>reportcard-server/src/main/java/io/github/ericdriggs/reportcard/persist/BrowseService.java</files>
  <action>
Add the following method to BrowseService (after getRun method, around line 580):

```java
/**
 * Get the latest (highest) run_id for a given job.
 * @param jobId the job ID
 * @return the latest run ID
 * @throws ResponseStatusException 404 if job has no runs
 */
public Long getLatestRunId(Long jobId) {
    Long result = dsl.select(max(RUN.RUN_ID))
            .from(RUN)
            .where(RUN.JOB_FK.eq(jobId))
            .fetchOne(0, Long.class);

    if (result == null) {
        throwNotFound("jobId: " + jobId, "no runs found");
    }
    return result;
}
```

Note: The `max()` function is already imported via `static io.github.ericdriggs.reportcard.gen.db.Tables.*` - verify this import exists at the top of the file. If not, add: `import static org.jooq.impl.DSL.max;`
  </action>
  <verify>
File compiles: `cd /Users/eric.r.driggs/github/ericdriggs/reportcard-browse-json && ./gradlew :reportcard-server:compileJava --quiet`
  </verify>
  <done>
getLatestRunId method exists in BrowseService with MAX query and null check for 404.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add unit tests for getLatestRunId</name>
  <files>reportcard-server/src/test/java/io/github/ericdriggs/reportcard/persist/browse/BrowseServiceTest.java</files>
  <action>
Add the following tests to BrowseServiceTest (after getRunFromReferenceTest, around line 186):

```java
@Test
void getLatestRunIdSuccessTest() {
    // TestData.jobId has known runs
    Long latestRunId = browseService.getLatestRunId(TestData.jobId);
    assertNotNull(latestRunId);
    assertTrue(latestRunId > 0, "Latest run ID should be positive");

    // Verify it matches the known run (runId 1 is the only run for jobId 1 in test data)
    assertEquals(1L, latestRunId, "Expected latest run ID to be 1 for test job");
}

@Test
void getLatestRunIdNotFoundTest() {
    // Use a job ID that definitely has no runs (very large number)
    Long nonExistentJobId = 999999L;

    ResponseStatusException ex = assertThrows(ResponseStatusException.class, () -> {
        browseService.getLatestRunId(nonExistentJobId);
    });

    assertEquals(404, ex.getStatus().value(), "Expected 404 status for job with no runs");
    assertNotNull(ex.getMessage());
    assertTrue(ex.getMessage().contains(nonExistentJobId.toString()),
        "Error message should contain job ID");
    assertTrue(ex.getMessage().contains("no runs found"),
        "Error message should indicate no runs found");
}
```

These tests follow the existing patterns in BrowseServiceTest for success and error cases.
  </action>
  <verify>
Run tests: `cd /Users/eric.r.driggs/github/ericdriggs/reportcard-browse-json && ./gradlew :reportcard-server:test --tests "io.github.ericdriggs.reportcard.persist.browse.BrowseServiceTest.getLatestRunId*" --quiet`
  </verify>
  <done>
Both tests pass - success test returns expected run ID, error test throws 404 for job with no runs.
  </done>
</task>

</tasks>

<verification>
1. Compile check: `./gradlew :reportcard-server:compileJava --quiet` - no errors
2. Test run: `./gradlew :reportcard-server:test --tests "*BrowseServiceTest*" --quiet` - all tests pass
3. Method exists: grep for `getLatestRunId` in BrowseService.java shows the method
</verification>

<success_criteria>
- [ ] getLatestRunId(Long jobId) method added to BrowseService
- [ ] Method uses MAX(RUN.RUN_ID) query with JOB_FK condition
- [ ] Method throws 404 ResponseStatusException when no runs found
- [ ] getLatestRunIdSuccessTest passes - returns correct run ID
- [ ] getLatestRunIdNotFoundTest passes - throws 404 for missing runs
- [ ] All existing BrowseServiceTest tests still pass
</success_criteria>

<output>
After completion, create `.planning/phases/02-latest-endpoints/02-01-SUMMARY.md`
</output>
