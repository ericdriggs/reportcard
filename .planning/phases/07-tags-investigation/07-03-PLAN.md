---
phase: 07-tags-investigation
plan: 03
type: execute
wave: 2
depends_on: ["07-01", "07-02"]
files_modified:
  - .planning/phases/07-tags-investigation/07-03-API-DESIGN-PROPOSAL.md
  - .planning/phases/07-tags-investigation/07-03-FUTURE-PHASES.md
autonomous: true

must_haves:
  truths:
    - "Simple tag search API designed with query params"
    - "Advanced expression search API designed"
    - "Functional traceability endpoint designed"
    - "Future implementation phases defined with scope"
  artifacts:
    - path: ".planning/phases/07-tags-investigation/07-03-API-DESIGN-PROPOSAL.md"
      provides: "Tag search API specification"
      contains: "REST endpoint definitions"
    - path: ".planning/phases/07-tags-investigation/07-03-FUTURE-PHASES.md"
      provides: "Implementation phase breakdown"
      contains: "Phase definitions with success criteria"
  key_links: []
---

<objective>
Design tag search API and define future implementation phases for tag functionality.

Purpose: Complete Phase 7 research by providing API specification and breaking down implementation work into actionable phases.
Output: API-DESIGN-PROPOSAL.md with endpoint specs, FUTURE-PHASES.md with phase definitions.
</objective>

<execution_context>
@/Users/eric.r.driggs/.claude/get-shit-done/workflows/execute-plan.md
@/Users/eric.r.driggs/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-tags-investigation/07-CONTEXT.md
@.planning/phases/07-tags-investigation/07-RESEARCH.md

# Reference prior plan outputs
@.planning/phases/07-tags-investigation/07-01-TAG-MAPPING-SPEC.md
@.planning/phases/07-tags-investigation/07-02-INDEXING-DECISION.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create API design proposal</name>
  <files>.planning/phases/07-tags-investigation/07-03-API-DESIGN-PROPOSAL.md</files>
  <action>
Create 07-03-API-DESIGN-PROPOSAL.md with:

1. **API Overview**:
   - Simple search: Query params on existing browse endpoints
   - Advanced search: Dedicated endpoint with expression syntax
   - Functional traceability: Latest run with data per job by tag

2. **Simple Tag Search** (extend existing browse):
   ```
   GET /api/v1/company/{company}/org/{org}/repo/{repo}/branch/{branch}/jobs?tags=smoke,regression&tagMatch=any

   Parameters:
   - tags: Comma-separated tag list (required for tag filtering)
   - tagMatch: "any" (OR) or "all" (AND), defaults to "any"

   Response: Existing job list response, filtered by tags
   ```

3. **Advanced Tag Search** (new endpoint):
   ```
   POST /api/v1/tags/search

   Request Body:
   {
     "expression": "smoke AND (env=staging OR env=prod)",
     "scope": {
       "company": "acme",
       "org": "platform",
       "repo": "api-tests"  // Optional filtering
     },
     "pagination": { "page": 0, "size": 20 }
   }

   Response: { "content": [...], "page": {...}, "total": N }
   ```

4. **Functional Traceability** (primary use case):
   ```
   GET /api/v1/tags/latest?company={company}&org={org}&job={job}&tags=smoke&hasData=true

   Parameters:
   - company, org: Required scope
   - job: Job name filter (optional - if omitted, returns all jobs)
   - tags: Tag filter (AND logic for traceability)
   - hasData: true = only runs with test data (reject empty uploads)

   Response: Map of job -> latest test result matching criteria
   ```

5. **Expression Grammar** (for parser implementation):
   ```
   expr     := term (OR term)*
   term     := factor (AND factor)*
   factor   := TAG | KEY=VALUE | NOT factor | ( expr )
   TAG      := [a-zA-Z0-9_-]+
   KEY      := [a-zA-Z0-9_]+
   VALUE    := [a-zA-Z0-9_.-]+
   ```
   - Precedence: NOT > AND > OR
   - Parentheses for explicit grouping
   - NOT supported in grammar but may not be in v1 API

6. **Response Structure**:
   - Results down to test level (test_result → test_suite → test_case)
   - Include matched tags in response for highlighting
   - Pagination for all search endpoints

7. **Error Handling**:
   - Invalid expression: 400 with parse error details
   - Empty results: 200 with empty content array
   - Invalid scope: 404 for unknown company/org/repo
  </action>
  <verify>
File exists: .planning/phases/07-tags-investigation/07-03-API-DESIGN-PROPOSAL.md
File contains simple search endpoint definition
File contains advanced search endpoint definition
File contains functional traceability endpoint definition
File contains expression grammar
  </verify>
  <done>
API-DESIGN-PROPOSAL.md provides complete REST API specification for tag-based search functionality.
  </done>
</task>

<task type="auto">
  <name>Task 2: Define future implementation phases</name>
  <files>.planning/phases/07-tags-investigation/07-03-FUTURE-PHASES.md</files>
  <action>
Create 07-03-FUTURE-PHASES.md defining implementation phases:

1. **Phase 8: Tag Extraction** (estimated: 2-3 plans)
   - Scope: Extract tags during Karate JSON parsing, store in test_suites_json
   - Depends on: Phase 3 (KarateConvertersUtil), Phase 7 (mapping spec)
   - Success Criteria:
     - Tags extracted from Karate JSON during upload
     - Feature tags stored in test_suite.tags
     - Scenario tags stored in test_case.tags
     - @ prefix stripped from stored tags
   - Plans estimate:
     - 08-01: Model changes for tag storage in test_suites_json
     - 08-02: KarateConvertersUtil tag extraction logic
     - 08-03: Integration tests for tag extraction

2. **Phase 9: Tag Indexing** (estimated: 2 plans)
   - Scope: Add MySQL multi-value indexes for tag search (based on 07-02 decision)
   - Depends on: Phase 8 (tags must exist to index)
   - Success Criteria:
     - Multi-value indexes created on tag columns
     - EXPLAIN shows index usage for tag queries
     - Collation matches (case-insensitive per CONTEXT.md)
   - Plans estimate:
     - 09-01: Schema migration adding indexes
     - 09-02: JOOQ query builder for tag conditions

3. **Phase 10: Simple Tag Search API** (estimated: 2 plans)
   - Scope: Query param filtering on existing browse endpoints
   - Depends on: Phase 9 (indexes for performance)
   - Success Criteria:
     - Tags query param accepted on browse endpoints
     - tagMatch parameter supports "any" and "all"
     - Performance acceptable at 10K-100K scale
   - Plans estimate:
     - 10-01: TagQueryBuilder JOOQ integration
     - 10-02: Browse endpoint modification, tests

4. **Phase 11: Advanced Tag Search** (estimated: 3 plans)
   - Scope: Expression parser, dedicated search endpoint
   - Depends on: Phase 10 (simple search validates query patterns)
   - Success Criteria:
     - Expression parser handles AND/OR/parentheses
     - POST /tags/search endpoint functional
     - Results include matched tags for highlighting
   - Plans estimate:
     - 11-01: Expression parser (recursive descent)
     - 11-02: TagSearchController and service
     - 11-03: Integration tests and documentation

5. **Optional: Phase 12: Functional Traceability View**
   - Scope: Latest-run-by-tag dashboard view
   - Depends on: Phase 11 (advanced search infrastructure)
   - Could be deferred based on user priority

6. **Recommendation**:
   - Implement Phases 8-10 as MVP (tag storage + simple search)
   - Phase 11 (advanced search) as fast-follow based on user feedback
   - Phase 12 can be user-driven enhancement

7. **Total Estimated Plans**: 9-11 across 4 phases
   - Timeline: ~45-55 minutes Claude execution time based on project velocity
  </action>
  <verify>
File exists: .planning/phases/07-tags-investigation/07-03-FUTURE-PHASES.md
File defines Phase 8 (extraction) with success criteria
File defines Phase 9 (indexing) with success criteria
File defines Phase 10 (simple API) with success criteria
File includes dependency chain
File includes MVP recommendation
  </verify>
  <done>
FUTURE-PHASES.md breaks down tag implementation into actionable phases with clear scope, dependencies, and success criteria.
  </done>
</task>

</tasks>

<verification>
- [ ] API-DESIGN-PROPOSAL.md exists with complete endpoint specifications
- [ ] FUTURE-PHASES.md exists with 4+ implementation phases defined
- [ ] All three CONTEXT.md API requirements addressed (simple, advanced, traceability)
- [ ] Expression grammar includes AND, OR, parentheses (NOT optional)
- [ ] Phase dependencies form valid DAG
- [ ] MVP recommendation clearly stated
</verification>

<success_criteria>
Phase success criteria #4 and #5 addressed:
- "API design proposal for tag-based queries"
- "Decision on whether to split into multiple implementation phases"
</success_criteria>

<output>
After completion, create `.planning/phases/07-tags-investigation/07-03-SUMMARY.md`
</output>
