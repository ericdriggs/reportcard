---
phase: 07-tags-investigation
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - .planning/phases/07-tags-investigation/07-02-INDEXING-ANALYSIS.md
autonomous: true

must_haves:
  truths:
    - "Four indexing strategies documented with trade-offs"
    - "Benchmark methodology defined for future validation"
    - "Specific EXPLAIN queries documented for each strategy"
    - "Decision explicitly DEFERRED pending benchmark execution"
  artifacts:
    - path: ".planning/phases/07-tags-investigation/07-02-INDEXING-ANALYSIS.md"
      provides: "Indexing strategy analysis and benchmark plan"
      contains: "Trade-offs, methodology, and deferred decision"
  key_links: []
---

<objective>
Analyze MySQL JSON indexing strategies and define benchmark methodology for future validation.

Purpose: Document what we know, what we can't know without testing, and exactly how to test it.
Output: Analysis document with deferred decision and complete benchmark specification.
</objective>

<execution_context>
@/Users/eric.r.driggs/.claude/get-shit-done/workflows/execute-plan.md
@/Users/eric.r.driggs/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-tags-investigation/07-CONTEXT.md
@.planning/phases/07-tags-investigation/07-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create indexing analysis with deferred decision</name>
  <files>.planning/phases/07-tags-investigation/07-02-INDEXING-ANALYSIS.md</files>
  <action>
Create 07-02-INDEXING-ANALYSIS.md with:

## 1. Decision Status

**DEFERRED** — Cannot recommend an indexing strategy without empirical EXPLAIN output.

Documentation claims multi-value indexes work for MEMBER OF queries, but we cannot verify:
- Whether MySQL actually uses the index for OR conditions
- How the optimizer handles multiple MEMBER OF in AND/OR combinations
- Actual rows examined and cost at 10K-100K scale

## 2. Strategies Analyzed

Document each strategy from RESEARCH.md with honest assessment:

| Strategy | What Docs Say | What We Don't Know |
|----------|---------------|-------------------|
| Multi-value index | Supports MEMBER OF queries | Whether OR/AND combinations use index or table scan |
| Generated columns | Can index extracted values | Performance vs multi-value for array membership |
| Functional indexes | Index expressions | Whether JSON path extraction is indexable |
| Junction table | Traditional normalized approach | Join overhead vs JSON query overhead |

## 3. Benchmark Specification

Define exactly what a future implementation phase must test:

### Test Setup
- MySQL 8.0.33 via Testcontainers
- 10,000 rows with 5-15 tags each
- Tag distribution: mix of simple tags and key=value pairs

### Queries to Benchmark

**Query 1: OR on tag keys**
```sql
EXPLAIN FORMAT=JSON
SELECT * FROM tag_benchmark
WHERE 'smoke' MEMBER OF(tags->'$[*]')
   OR 'regression' MEMBER OF(tags->'$[*]')
   OR 'critical' MEMBER OF(tags->'$[*]');
```

**Query 2: OR on key=value pairs**
```sql
EXPLAIN FORMAT=JSON
SELECT * FROM tag_benchmark
WHERE 'env=staging' MEMBER OF(tags->'$[*]')
   OR 'env=prod' MEMBER OF(tags->'$[*]');
```

**Query 3: AND on key=value pairs**
```sql
EXPLAIN FORMAT=JSON
SELECT * FROM tag_benchmark
WHERE 'env=staging' MEMBER OF(tags->'$[*]')
  AND 'browser=chrome' MEMBER OF(tags->'$[*]');
```

### What to Look For in EXPLAIN Output
- `access_type`: Should be "ref" or better, NOT "ALL" (table scan)
- `possible_keys`: Should list the multi-value index
- `key`: Should show index actually used
- `rows_examined_per_scan`: Should be << total rows for selective queries

### Acceptance Criteria for Multi-Value Index
- All three query patterns show index usage
- Rows examined < 20% of total for selective queries
- No "Using where; Using temporary" that indicates post-filter

### If Benchmark Fails
Junction table becomes the recommendation:
```sql
CREATE TABLE test_suite_tags (
    test_suite_id BIGINT NOT NULL,
    tag VARCHAR(100) NOT NULL,
    PRIMARY KEY (test_suite_id, tag),
    INDEX idx_tag (tag)
);
```

## 4. Recommendation Path

If user chooses to implement tag search:
1. Run benchmark (future phase creates test, executes, captures EXPLAIN)
2. If multi-value index works → use it (simpler schema)
3. If multi-value index fails → use junction table (proven approach)

## 5. Open Questions for Implementation Phase

- Case sensitivity: utf8mb4_bin vs utf8mb4_0900_ai_ci
- Tag cardinality: log max tags per test in production data
- Collation matching: ensure query collation matches index
  </action>
  <verify>
File exists: .planning/phases/07-tags-investigation/07-02-INDEXING-ANALYSIS.md
Decision is explicitly DEFERRED (not a speculative recommendation)
Benchmark methodology is complete and actionable
All three query patterns documented with EXPLAIN guidance
Junction table fallback documented
  </verify>
  <done>
Indexing analysis complete with deferred decision and benchmark specification for future phase.
  </done>
</task>

</tasks>

<verification>
- [ ] INDEXING-ANALYSIS.md exists
- [ ] Decision clearly states DEFERRED
- [ ] Four strategies documented with trade-offs
- [ ] Benchmark queries specified exactly
- [ ] Acceptance criteria defined
- [ ] Fallback strategy documented
</verification>

<success_criteria>
Phase success criteria #2 and #3 addressed:
- "Clear understanding of MySQL JSON indexing options and limitations" — documented with honest unknowns
- "Recommendation on indexing strategy (or decision to defer indexing)" — DEFERRED with clear path forward
</success_criteria>

<output>
After completion, create `.planning/phases/07-tags-investigation/07-02-SUMMARY.md`
</output>
