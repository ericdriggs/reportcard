---
phase: 07-tags-investigation
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - reportcard-server/src/test/java/io/github/ericdriggs/reportcard/persist/TagIndexBenchmarkTest.java
  - .planning/phases/07-tags-investigation/07-02-BENCHMARK-RESULTS.md
  - .planning/phases/07-tags-investigation/07-02-INDEXING-DECISION.md
autonomous: false

must_haves:
  truths:
    - "EXPLAIN output captured for all three query patterns"
    - "Index usage verified (or disproven) empirically"
    - "Benchmark ran against MySQL 8.0.33 via Testcontainers"
    - "Decision based on actual query plans, not documentation speculation"
  artifacts:
    - path: "reportcard-server/src/test/java/io/github/ericdriggs/reportcard/persist/TagIndexBenchmarkTest.java"
      provides: "Executable benchmark test"
      contains: "EXPLAIN FORMAT=JSON queries"
    - path: ".planning/phases/07-tags-investigation/07-02-BENCHMARK-RESULTS.md"
      provides: "Raw EXPLAIN output for each query pattern"
      contains: "Query plans showing index usage or table scan"
    - path: ".planning/phases/07-tags-investigation/07-02-INDEXING-DECISION.md"
      provides: "Indexing decision based on empirical evidence"
      contains: "Recommendation citing benchmark results"
  key_links: []
---

<objective>
Run actual benchmark against MySQL 8.0.33 to verify multi-value index behavior for tag queries.

Purpose: Get empirical EXPLAIN output before making any indexing recommendation.
Output: Benchmark test, raw EXPLAIN results, and evidence-based decision document.
</objective>

<execution_context>
@/Users/eric.r.driggs/.claude/get-shit-done/workflows/execute-plan.md
@/Users/eric.r.driggs/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-tags-investigation/07-CONTEXT.md
@.planning/phases/07-tags-investigation/07-RESEARCH.md
@reportcard-server/src/test/java/io/github/ericdriggs/reportcard/persist/test_result/TestResultPersistServiceTest.java
</context>

<tasks>

<task type="checkpoint">
  <name>Task 1: Create benchmark test for multi-value index</name>
  <files>reportcard-server/src/test/java/io/github/ericdriggs/reportcard/persist/TagIndexBenchmarkTest.java</files>
  <action>
Create TagIndexBenchmarkTest.java that:

1. **Setup** - Use existing Testcontainers MySQL 8.0.33 pattern from project
2. **Create test table** with tags JSON column:
   ```sql
   CREATE TABLE tag_benchmark (
       id BIGINT AUTO_INCREMENT PRIMARY KEY,
       name VARCHAR(255),
       tags JSON DEFAULT NULL
   );
   ```

3. **Create multi-value index**:
   ```sql
   CREATE INDEX idx_tags ON tag_benchmark (
       (CAST(tags->'$[*]' AS CHAR(100) COLLATE utf8mb4_0900_ai_ci ARRAY))
   );
   ```

4. **Load 10,000 rows** with realistic tag distribution:
   - 5-15 tags per row
   - Mix of simple tags: smoke, regression, critical, integration, unit
   - Mix of key-value tags: env=staging, env=prod, browser=chrome, browser=firefox

5. **Run EXPLAIN FORMAT=JSON** for each query pattern and capture output:

   **Query 1: OR list on tag keys**
   ```sql
   EXPLAIN FORMAT=JSON
   SELECT * FROM tag_benchmark
   WHERE 'smoke' MEMBER OF(tags->'$[*]')
      OR 'regression' MEMBER OF(tags->'$[*]')
      OR 'critical' MEMBER OF(tags->'$[*]');
   ```

   **Query 2: OR list on key=value pairs**
   ```sql
   EXPLAIN FORMAT=JSON
   SELECT * FROM tag_benchmark
   WHERE 'env=staging' MEMBER OF(tags->'$[*]')
      OR 'env=prod' MEMBER OF(tags->'$[*]');
   ```

   **Query 3: AND list on key=value pairs**
   ```sql
   EXPLAIN FORMAT=JSON
   SELECT * FROM tag_benchmark
   WHERE 'env=staging' MEMBER OF(tags->'$[*]')
     AND 'browser=chrome' MEMBER OF(tags->'$[*]');
   ```

6. **Print EXPLAIN output** to console for each query
7. **Assert index usage** - test should verify "using_index" or appropriate access type

The test should be runnable standalone and output clear EXPLAIN JSON for analysis.
  </action>
  <verify>
Test file compiles
Test runs against Testcontainers MySQL 8.0.33
EXPLAIN output printed for all three query patterns
Output shows whether index is used or table scan occurs
  </verify>
  <checkpoint>
STOP after creating the test. Run it and show me the EXPLAIN output before proceeding.
I need to see the actual query plans to make any indexing decision.
  </checkpoint>
</task>

<task type="auto">
  <name>Task 2: Document benchmark results</name>
  <files>.planning/phases/07-tags-investigation/07-02-BENCHMARK-RESULTS.md</files>
  <action>
After running the benchmark test, create 07-02-BENCHMARK-RESULTS.md with:

1. **Test Environment**
   - MySQL version (8.0.33)
   - Row count (10,000)
   - Tag distribution (5-15 per row)

2. **Query Pattern 1: OR on tag keys**
   - Raw EXPLAIN JSON output
   - Analysis: Index used? Access type? Rows examined?

3. **Query Pattern 2: OR on key=value pairs**
   - Raw EXPLAIN JSON output
   - Analysis: Index used? Access type? Rows examined?

4. **Query Pattern 3: AND on key=value pairs**
   - Raw EXPLAIN JSON output
   - Analysis: Index used? Access type? Rows examined?

5. **Summary Table**
   | Pattern | Index Used | Access Type | Rows Examined | Cost |
   |---------|------------|-------------|---------------|------|
   | OR keys | ? | ? | ? | ? |
   | OR kv   | ? | ? | ? | ? |
   | AND kv  | ? | ? | ? | ? |

Include raw EXPLAIN output - don't summarize away the evidence.
  </action>
  <verify>
File contains actual EXPLAIN JSON output (not hypothetical)
All three query patterns documented
Summary table filled with real numbers
  </verify>
  <done>
Benchmark results documented with raw evidence from actual MySQL execution.
  </done>
</task>

<task type="auto">
  <name>Task 3: Make evidence-based indexing decision</name>
  <files>.planning/phases/07-tags-investigation/07-02-INDEXING-DECISION.md</files>
  <action>
Create 07-02-INDEXING-DECISION.md based on benchmark results:

1. **Decision** (1-2 sentences)
   - State recommendation based on EXPLAIN evidence
   - If multi-value index works: recommend it with DDL
   - If multi-value index fails: recommend junction table alternative

2. **Evidence Summary**
   - Reference 07-02-BENCHMARK-RESULTS.md
   - Cite specific EXPLAIN output that supports decision
   - Note any query patterns where index was NOT used

3. **Implementation DDL** (if recommending multi-value index)
   ```sql
   -- Only include if benchmark proves index works
   ALTER TABLE test_suite ADD COLUMN tags JSON DEFAULT NULL;
   CREATE INDEX idx_test_suite_tags ON test_suite (...);
   ```

4. **Alternative** (if multi-value index doesn't work)
   - Junction table schema
   - Migration approach

5. **Open Questions Remaining**
   - Case sensitivity (decided by collation choice)
   - Scale beyond 10K (extrapolation from benchmark)

DO NOT recommend multi-value indexes if EXPLAIN shows table scan.
  </action>
  <verify>
Decision cites specific benchmark evidence
Recommendation matches what EXPLAIN output showed
DDL only included if benchmark proved it works
  </verify>
  <done>
Indexing decision made based on empirical evidence, not documentation speculation.
  </done>
</task>

</tasks>

<verification>
- [ ] Benchmark test exists and runs
- [ ] EXPLAIN output captured for all three query patterns
- [ ] Results document contains raw EXPLAIN JSON
- [ ] Decision document cites benchmark evidence
- [ ] Recommendation matches actual query plan behavior
</verification>

<success_criteria>
Phase success criteria #2 and #3 addressed:
- "Clear understanding of MySQL JSON indexing options and limitations" - FROM ACTUAL EXPLAIN OUTPUT
- "Recommendation on indexing strategy (or decision to defer indexing)" - BASED ON EVIDENCE
</success_criteria>

<output>
After completion, create `.planning/phases/07-tags-investigation/07-02-SUMMARY.md`
</output>
